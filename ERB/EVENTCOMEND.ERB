@EVENTCOM
;ターン終了の処理


@EVENTCOMEND0
#DIM 食事回復量
#DIM 料理ランク一時保存
#DIM 料理属性一時保存, 10

IF TFLAG:オートコマンドフラグ
ELSE
	;処理の都合上、身体に触れる派生は履歴に載せない
	SIF SELECTCOM == 306
		RSTR:SELECTCOM_S受け渡し = 

	;コマンド履歴の保存
	コマンド履歴:19 = コマンド履歴:18
	コマンド履歴:18 = コマンド履歴:17
	コマンド履歴:17 = コマンド履歴:16
	コマンド履歴:16 = コマンド履歴:15
	コマンド履歴:15 = CFLAG:MASTER:現在マップ種別
	コマンド履歴:14 = コマンド履歴:13
	コマンド履歴:13 = コマンド履歴:12
	コマンド履歴:12 = コマンド履歴:11
	コマンド履歴:11 = コマンド履歴:10
	コマンド履歴:10 = CFLAG:MASTER:現在位置
	コマンド履歴:9 = コマンド履歴:8
	コマンド履歴:8 = コマンド履歴:7
	コマンド履歴:7 = コマンド履歴:6
	コマンド履歴:6 = コマンド履歴:5
	コマンド履歴:5 = TARGET
	コマンド履歴:4 = コマンド履歴:3
	コマンド履歴:3 = コマンド履歴:2
	コマンド履歴:2 = コマンド履歴:1
	コマンド履歴:1 = コマンド履歴:0
	IF RSTR:SELECTCOM_S受け渡し == ""
		コマンド履歴:0 = SELECTCOM
	ELSE
		コマンド履歴:0 = -1
	ENDIF
	派生コマンド履歴:4 = %派生コマンド履歴:3%
	派生コマンド履歴:3 = %派生コマンド履歴:2%
	派生コマンド履歴:2 = %派生コマンド履歴:1%
	派生コマンド履歴:1 = %派生コマンド履歴:0%
	派生コマンド履歴:0 = %RSTR:SELECTCOM_S受け渡し%
ENDIF

;リセット前に次ターン自動行動をするか判定、指示モードだと発動しない
IF FLAG:モード管理 != 1
	FLAG:オートコマンド判定中フラグ = 1
	CALL BEFORE_AUTOCOM
	TFLAG:オートコマンドフラグ = RESULT
	FLAG:オートコマンド判定中フラグ = 0
ENDIF

;キャラごとの特殊処理を呼び出す
TRYCALLFORM TURNEND_CHARAEVENT_{NO:TARGET}

;初うふふ突入時処理
IF フレーバー素質:TARGET:素質表示設定 == 3 && TCVAR:TARGET:初うふふフラグ
	PRINTL
	PRINTW 初うふふ突入のため、フレーバー素質設定画面を開きます。
	CALL フレーバー素質個別設定画面(TARGET)
ENDIF

;諸々リセット
CALL TURN_RESET

;自室訪問時、遊びに行く際の処理
;リセットの後に置くことで、前ターン位置記録の後に処理している
IF 訪問先場所番号
	CFLAG:AUTOCOM_相手番号保存:現在位置 = 訪問先場所番号
	CFLAG:PLAYER:現在位置 = 訪問先場所番号
	訪問先場所番号 = 0
ENDIF


;パンツ収集要素……とりあえず封印
;パンツ没収、収集
;IF TFLAG:調教モード < 2
;	IF TARGET > 0 && !CFLAG:睡眠
;		IF STRLENS(CSTR:MASTER:12) && RAND:2
;			PRINTL 
;			PRINTFORMW %CALLNAME:TARGET%に見とがめられ身体検査をされた…
;			PRINTFORMW 
;			PRINTFORMW 
;			PRINTFORMW 
;			PRINTFORMW くすねたパンティを没収された
;			SIF !GETBIT (CFLAG:10 ,0)
;				PRINTFORMW %CALLNAME:TARGET%に弱みを握られた
;			SETBIT CFLAG:10 ,0
;			CALL KOJO_EVENT(11, TARGET, 0)
;			CSTR:MASTER:12 =
;		ENDIF
;	ENDIF
;ENDIF

;設定している食事メニューによって回復量設定
食事回復量 = 400
料理ランク一時保存 = 0
VARSET 料理属性一時保存
FOR LOCAL, 1, 6
	IF 現在設定メニュー:LOCAL
		料理ランク一時保存 += DT_CELL_GET("料理メニューデータベース", 現在設定メニュー:LOCAL, "料理ランク", 1)
		料理属性一時保存:LOCAL = DT_CELL_GET("料理メニューデータベース", 現在設定メニュー:LOCAL, "料理属性", 1) + 100
	ENDIF
NEXT
食事回復量 += 料理ランク一時保存 * 10


FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:滞在期間 < 0
		CONTINUE
	;知識系素質の取得処理
	CALL 知識系素質の取得(LOCAL)
	;体力の回復
	;昼食
	IF TIME > 720 && !GETBIT(TCVAR:LOCAL:食事済みフラグ, 0) && !CFLAG:LOCAL:うふふ
		;回復早い、回復遅い
		SELECTCASE MATCH(料理属性一時保存, 基礎BATTLE_STATE:LOCAL:属性 + 100)
			CASE 3
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 12 / 10)
			CASE 4
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 14 / 10)
			CASE 5
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 16 / 10)
		ENDSELECT
		SETBIT TCVAR:LOCAL:食事済みフラグ, 0
	ENDIF
	;夕食
	IF TIME > 1140 && !GETBIT(TCVAR:LOCAL:食事済みフラグ, 1) && !CFLAG:LOCAL:うふふ
		;回復早い、回復遅い
		BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)))
		SELECTCASE MATCH(料理属性一時保存, 基礎BATTLE_STATE:LOCAL:属性 + 100)
			CASE 3
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 12 / 10)
			CASE 4
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 14 / 10)
			CASE 5
				BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + (食事回復量 * 3 / (3 - TALENT:LOCAL:回復速度)) * 16 / 10)
		ENDSELECT
		SETBIT TCVAR:LOCAL:食事済みフラグ, 1
	ENDIF
	;風呂
	IF BATHROOM(CFLAG:LOCAL:現在マップ種別, CFLAG:LOCAL:現在位置) && !CFLAG:LOCAL:うふふ
		;回復早い、回復遅い
		BASE:LOCAL:体力 = MIN(MAXBASE:LOCAL:体力, BASE:LOCAL:体力 + ((TIME - TIME:2) * 30 / (3 - TALENT:LOCAL:回復速度)))
	ENDIF
NEXT

IF CFLAG:MASTER:酔いすぎ == 1
	TFLAG:オートコマンドフラグ = 0

	PRINTW （酔いつぶれてしまいました…　一日を終了します）
	;二日酔い処理のため、酩酊が残ってたら絶対値を負に
	BASE:MASTER:酩酊 = BASE:MASTER:酩酊 * -1

	CFLAG:MASTER:睡眠 = 1
	CFLAG:MASTER:就寝時刻 = DAY * 1440 + TIME
	IF TARGET > 0 && TALENT:恋慕 && BASE:体力 >= 1
		PRINTFORMW %CALLNAME%が%CALLNAME:MASTER%を私室へと運んでくれた…
		CFLAG:MASTER:現在位置 = CFLAG:MASTER:311
		CFLAG:MASTER:現在マップ種別 = 0
		CFLAG:現在位置 = CFLAG:MASTER:311
		CFLAG:現在マップ種別 = 0
		CALL KOJO_EVENT(7, TARGET, 5)
	ENDIF
	FOR LOCAL,0,CHARANUM
		CFLAG:LOCAL:うふふ = 0
		CALL 性欲ゲージ減少処理(LOCAL)
		CFLAG:LOCAL:飲み会 = 0
		TCVAR:LOCAL:初うふふフラグ = 0
	NEXT
	TFLAG:あなたターゲット用 = 0
	VARSET 同時モード_選択キャラ, -1
	同時モード_選択数 = 0
	FLAG:モード管理 = 0
	FLAG:一日終了 = 1
ENDIF
IF TARGET && RCVAR:不機嫌
	PRINTFORMW %CALLNAME:TARGET%を怒らせてしまった…
	SIF AUTOCOM_相手番号保存 == TARGET
		TFLAG:オートコマンドフラグ = 0
	FOR LOCAL,0,CHARANUM
		CFLAG:LOCAL:うふふ = 0
		CALL 性欲ゲージ減少処理(LOCAL)
		CFLAG:LOCAL:飲み会 = 0
		TCVAR:LOCAL:初うふふフラグ = 0
		;モードもリセット
		DT_CLEAR "体位モードデータベース"
	NEXT
	FLAG:モード管理 = 0
	TFLAG:あなたターゲット用 = 0
	VARSET 同時モード_選択キャラ, -1
	同時モード_選択数 = 0
ENDIF
FOR LOCAL, 1, CHARANUM
	SIF TARGET:LOCAL < 1
		BREAK
	IF BASE:(TARGET:LOCAL):体力 < 1
		PRINTFORMW （%CALLNAME:(TARGET:LOCAL)%の体力が限界に来ています）
		CFLAG:(TARGET:LOCAL):体力限界 = 1
		CALL CHARA_SLEEP, TARGET:LOCAL
		CFLAG:(TARGET:LOCAL):うふふ = 0
		CALL 性欲ゲージ減少処理(TARGET:LOCAL)
		CFLAG:(TARGET:LOCAL):飲み会 = 0
		TCVAR:(TARGET:LOCAL):初うふふフラグ = 0
		SIF AUTOCOM_相手番号保存 == TARGET:LOCAL
			TFLAG:オートコマンドフラグ = 0
		;モードもリセット
		CALL 特定キャラモードリセット(TARGET:LOCAL)
		FLAG:モード管理 = 0
		TFLAG:あなたターゲット用 = 0
		VARSET 同時モード_選択キャラ, -1
		同時モード_選択数 = 0
	ENDIF
NEXT
FOR LOCAL, 1, CHARANUM
	SIF 飲み会TARGET:LOCAL < 1
		BREAK
	IF BASE:(飲み会TARGET:LOCAL):体力 < 1
		PRINTFORMW （%CALLNAME:(飲み会TARGET:LOCAL)%の体力が限界に来ています）
		CFLAG:(飲み会TARGET:LOCAL):体力限界 = 1
		CALL CHARA_SLEEP, 飲み会TARGET:LOCAL
		CFLAG:(飲み会TARGET:LOCAL):うふふ = 0
		CALL 性欲ゲージ減少処理(飲み会TARGET:LOCAL)
		CFLAG:(飲み会TARGET:LOCAL):飲み会 = 0
		TCVAR:(飲み会TARGET:LOCAL):初うふふフラグ = 0
		SIF AUTOCOM_相手番号保存 == 飲み会TARGET:LOCAL
			TFLAG:オートコマンドフラグ = 0
		;モードもリセット
		CALL 特定キャラモードリセット(飲み会TARGET:LOCAL)
		FLAG:モード管理 = 0
		TFLAG:あなたターゲット用 = 0
		VARSET 同時モード_選択キャラ, -1
		同時モード_選択数 = 0
	ENDIF
NEXT

LOCAL = TIME - TIME:2
IF LOCAL > 0
	PRINTL
	PRINTFORML \@ LOCAL / 60 > 0?{LOCAL / 60}時間# \@{LOCAL % 60}分 経過
ENDIF
TIME:2 = TIME > 1440 ? TIME - 1440 # TIME

WAIT




@TURN_RESET
#DIM 同室番号

SIF !TFLAG:オートコマンドフラグ
	自慰ターゲット保存 = -1

FOR LOCAL,0,CHARANUM
	;処女喪失
	SIF RCVAR:LOCAL:破瓜
		TALENT:LOCAL:処女 = 0

	SIF CFLAG:LOCAL:滞在期間 < 0
		CONTINUE

	;満腹残り時間の減少
	TCVAR:LOCAL:満腹 = MAX(TCVAR:LOCAL:満腹 - TIME_PROGRESS(TFLAG:行動前時刻), 0)
	
	IF TCVAR:LOCAL:前ターン絶頂 && NOWEX:LOCAL:多重絶頂
		TCVAR:LOCAL:連続絶頂記録 += 1
	ELSE
		TCVAR:LOCAL:連続絶頂記録 = 0
	ENDIF
	TCVAR:LOCAL:前ターン絶頂 = NOWEX:LOCAL:多重絶頂
	TCVAR:LOCAL:前ターンＣ絶頂 = NOWEX:LOCAL:Ｃ絶頂
	TCVAR:LOCAL:前ターンＢ絶頂 = NOWEX:LOCAL:Ｂ絶頂
	TCVAR:LOCAL:前ターンＶ絶頂 = NOWEX:LOCAL:Ｖ絶頂
	TCVAR:LOCAL:前ターンＡ絶頂 = NOWEX:LOCAL:Ａ絶頂
	TCVAR:LOCAL:前ターンＳ絶頂 = NOWEX:LOCAL:Ｓ絶頂
	TCVAR:LOCAL:前ターン被射精位置 = TCVAR:LOCAL:被射精位置
	SIF !TFLAG:オートコマンドフラグ
		TCVAR:LOCAL:被射精位置 = 0

	IF CFLAG:LOCAL:うふふ && LOCAL != PLAYER
		;既成事実
		SETBIT CFLAG:LOCAL:1 , 1

		;絶頂累積
		TCVAR:LOCAL:うふふ中Ｃ絶頂累積 += NOWEX:LOCAL:Ｃ絶頂
		TCVAR:LOCAL:うふふ中Ｂ絶頂累積 += NOWEX:LOCAL:Ｂ絶頂
		TCVAR:LOCAL:うふふ中Ｖ絶頂累積 += NOWEX:LOCAL:Ｖ絶頂
		TCVAR:LOCAL:うふふ中Ａ絶頂累積 += NOWEX:LOCAL:Ａ絶頂
		TCVAR:LOCAL:うふふ中Ｓ絶頂累積 += NOWEX:LOCAL:Ｓ絶頂
		
		;複数プレイ中なら関係性上昇(何もしない実行時を除く)
		FOR 同室番号, 1, CHARANUM
			SIF TARGET:同室番号 < 1
				BREAK
			SIF TARGET:同室番号 == LOCAL
				CONTINUE
			SIF CFLAG:(TARGET:同室番号):うふふ == 0
				CONTINUE
			SIF CFLAG:(TARGET:同室番号):隠密 != CFLAG:LOCAL:隠密
				CONTINUE

			CALL ADD_RELATION(LOCAL, TARGET:同室番号, MAX(15, TIME - TIME:2) / 15)
		NEXT
	ENDIF

	;CUP等のリセット
	VARSET CUP:LOCAL:0, 0
	VARSET CDOWN:LOCAL:0, 0
	VARSET DOWNBASE:LOCAL:0, 0
	TCVAR:LOCAL:野外オナニー_絶頂 = 0
	;NOWEXのリセット
	VARSET NOWEX:LOCAL:0, 0
	CFLAG:LOCAL:快楽計算フラグ = 0
	TCVAR:LOCAL:弱点コマンドフラグ = 0

	;経験値取表示用
	;現在位置の保存
	CFLAG:LOCAL:前ターン位置 = CFLAG:LOCAL:現在位置
	CFLAG:LOCAL:前マップ種別 = CFLAG:LOCAL:現在マップ種別
	FOR LOCAL:1,0,200
		TCVAR:LOCAL:(400 + LOCAL:1) = EXP:LOCAL:(LOCAL:1)
	NEXT

NEXT

;童貞喪失
IF TALENT:MASTER:2 & 2
	SELECTCASE SELECTCOM
		CASE 60,61,65,67,68
			TALENT:MASTER:1 |= 1
		CASE 62,63,66,69,70
			TALENT:MASTER:1 |= 2
	ENDSELECT
ENDIF
IF TALENT:2 & 2
	SELECTCASE SELECTCOM
		CASE 64
			TALENT:1 |= 1
		CASE 92,93,94
			TALENT:1 |= 2
		CASE 71
			TALENT:1 |= 1
	ENDSELECT
ENDIF

;告白成功
SIF SELECTCOM == 352 && RFLAG:コマンド結果受渡し変数
	SETBIT CFLAG:1 , 0

;脱衣コマンド
SELECTCASE SELECTCOM
	;上半身鎧脱衣
	CASE 200
		TEQUIP:上半身鎧あり = 0
	;上半身服脱衣
	CASE 201
		TEQUIP:上半身服あり = 0
		TEQUIP:脇出し = 0
		TEQUIP:へそ出し = 0
		TEQUIP:はだけ可 = 0
		TEQUIP:手差し込み可 = 0
		TEQUIP:パイズリ可 = 0
		TEQUIP:上半身下着抜き取り可 = 0
		;上下一体の場合ここで下も脱がす
		IF TEQUIP:上下一体服
			TEQUIP:下半身服あり = 0
			TEQUIP:スカートめくり可 = 0
			TEQUIP:下半身下着抜き取り可 = 0
			TEQUIP:ずらし可 = 0
			TEQUIP:上下一体服 = 0
		ENDIF
	;上半身タイツ脱衣
	CASE 202
		TEQUIP:上タイツあり = 0
		TEQUIP:上タイツ破れ = 0
		;上下一体の場合ここで下も脱がす
		IF TEQUIP:上下一体タイツ
			TEQUIP:下タイツあり = 0
			TEQUIP:下タイツ破れ = 0
			TEQUIP:上下一体タイツ = 0
		ENDIF
	;下半身鎧脱衣、前と後ろは一気に脱がす
	CASE 203
		TEQUIP:下腹部後鎧あり = 0
		TEQUIP:下腹部前鎧あり = 0
	;下半身服脱衣
	CASE 204
		TEQUIP:下半身服あり = 0
		TEQUIP:スカートめくり可 = 0
		TEQUIP:下半身下着抜き取り可 = 0
		TEQUIP:ずらし可 = 0
	;下半身タイツ脱衣
	CASE 205
		TEQUIP:下タイツあり = 0
		TEQUIP:下タイツ破れ = 0
	;ブラ脱衣
	CASE 206
		TEQUIP:上半身下着あり = 0
	;下着脱衣
	CASE 207
		TEQUIP:下半身下着あり = 0
	;全裸にする
	CASE 208
		IF FLAG:モード管理 == 2
			FOR LOCAL, 0, 同時モード_選択数
				TEQUIP:(同時モード_選択キャラ:LOCAL):上半身鎧あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上半身服あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):脇出し = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):へそ出し = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):はだけ可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):手差し込み可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):パイズリ可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上タイツあり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上半身下着あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上半身下着抜き取り可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下腹部後鎧あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下腹部前鎧あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下半身服あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):スカートめくり可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):ずらし可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下タイツあり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下半身下着あり = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下半身下着抜き取り可 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上下一体服 = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上下一体タイツ = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):上タイツ破れ = 0
				TEQUIP:(同時モード_選択キャラ:LOCAL):下タイツ破れ = 0
			NEXT
		ELSE
			TEQUIP:TARGET:上半身鎧あり = 0
			TEQUIP:TARGET:上半身服あり = 0
			TEQUIP:TARGET:脇出し = 0
			TEQUIP:TARGET:へそ出し = 0
			TEQUIP:TARGET:はだけ可 = 0
			TEQUIP:TARGET:手差し込み可 = 0
			TEQUIP:TARGET:パイズリ可 = 0
			TEQUIP:TARGET:上タイツあり = 0
			TEQUIP:TARGET:上半身下着あり = 0
			TEQUIP:TARGET:上半身下着抜き取り可 = 0
			TEQUIP:TARGET:下腹部後鎧あり = 0
			TEQUIP:TARGET:下腹部前鎧あり = 0
			TEQUIP:TARGET:下半身服あり = 0
			TEQUIP:TARGET:スカートめくり可 = 0
			TEQUIP:TARGET:ずらし可 = 0
			TEQUIP:TARGET:下タイツあり = 0
			TEQUIP:TARGET:下半身下着あり = 0
			TEQUIP:TARGET:下半身下着抜き取り可 = 0
			TEQUIP:TARGET:上下一体服 = 0
			TEQUIP:TARGET:上下一体タイツ = 0
			TEQUIP:TARGET:上タイツ破れ = 0
			TEQUIP:TARGET:下タイツ破れ = 0
		ENDIF
ENDSELECT




;フラグのリセット
CALL R系列フラグリセット
TFLAG:調教者絶頂強度 = 0


PREVCOM = SELECTCOM


@R系列フラグリセット

#DIM キャラ番号
VARSET RFLAG
VARSET RSTR
FOR キャラ番号,0,CHARANUM
	VARSET RCVAR:キャラ番号:0
NEXT

