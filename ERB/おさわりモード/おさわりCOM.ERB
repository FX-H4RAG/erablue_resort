;-----------------
;罫線や改行の表示を飛ばしたCOM
;-----------------
@おさわりMASSAGE_COM(有効アロマフラグ)
#DIM REF 有効アロマフラグ,0
#DIM 警戒度保存
#DIM 理性保存
#DIM 警戒度変化量
#DIM 理性変化量

;アロマ効果のために変化前の値を保存
警戒度保存 = BASE:TARGET:警戒
理性保存 = BASE:TARGET:理性

RESULT = 0
TCVAR:TARGET:弱点コマンドフラグ = 0
弱点コマンドカテゴリ = 
IF RSTR:SELECTCOM_S受け渡し != ""
	IF TCVAR:TARGET:食いしばりフラグ
	ELSE
		TRYCALLFORM MASSAGE_CAN_COM_S%RSTR:SELECTCOM_S受け渡し%
	ENDIF
	TRYCALLFORMF MASSAGE_COMTYPE_S_%RSTR:SELECTCOM_S受け渡し%
	TRYCALLFORM MASSAGE_COM_S%RSTR:SELECTCOM_S受け渡し%
	LOCAL:1 = RESULT
	IF LOCAL:1 >= 0
		LOCALS = %RSTR:SELECTCOM_S受け渡し%
		IF STRFIND(コマンド初回フラグ:TARGET:0, @"-MASSAGE_%LOCALS%-") < 0
			コマンド初回フラグ_一時保存:TARGET:0 += @"-MASSAGE_%LOCALS%-"
		ENDIF
		IF STRFIND(コマンド初回フラグ_PLAYER:PLAYER:0, @"-MASSAGE_%LOCALS%-") < 0
			コマンド初回フラグ_PLAYER_一時保存:PLAYER:0 += @"-MASSAGE_%LOCALS%-"
		ENDIF
	ENDIF
	SPLIT RSTR:SELECTCOM_S受け渡し, "_", RESULTS
ELSE
	IF TCVAR:TARGET:食いしばりフラグ
	ELSE
		TRYCALLFORM MASSAGE_CAN_COM{SELECTCOM}
	ENDIF
	TRYCALLFORMF MASSAGE_COMTYPE_{SELECTCOM}
	TRYCALLFORM MASSAGE_COM{SELECTCOM}
	LOCAL:1 = RESULT
	IF LOCAL:1 >= 0
		LOCALS = {SELECTCOM}
		IF STRFIND(コマンド初回フラグ:TARGET:0, @"-MASSAGE_%LOCALS%-") < 0
			コマンド初回フラグ_一時保存:TARGET:0 += @"-MASSAGE_%LOCALS%-"
		ENDIF
		IF STRFIND(コマンド初回フラグ_PLAYER:PLAYER:0, @"-MASSAGE_%LOCALS%-") < 0
			コマンド初回フラグ_PLAYER_一時保存:PLAYER:0 += @"-MASSAGE_%LOCALS%-"
		ENDIF
	ENDIF
ENDIF

;変化量をもとにアロマ効果をつける
;効果は同時発動可能にするので別のIFで判定する
警戒度変化量 = BASE:TARGET:警戒 - 警戒度保存
理性変化量 = BASE:TARGET:理性 - 理性保存

;警戒度上昇抑制
IF 警戒度変化量 > 0 && 有効アロマフラグ:2
    有効アロマフラグ:2 --
    警戒度変化量 = 警戒度変化量 / 2
ENDIF
;警戒度減少強化
IF 警戒度変化量 < 0 && 有効アロマフラグ:0
    有効アロマフラグ:0 --
    警戒度変化量 = 警戒度変化量 * 2
ENDIF
;理性抑制
IF 理性変化量 > 0 && 有効アロマフラグ:1
    有効アロマフラグ:1 --
    理性変化量 = 理性変化量 / 2
ELSEIF 理性変化量 < 0 && 有効アロマフラグ:1
    有効アロマフラグ:1 --
    理性変化量 = 理性変化量 * 2
ENDIF

;再計算する
BASE:TARGET:警戒 = 警戒度保存 + 警戒度変化量
BASE:TARGET:理性 = 理性保存 + 理性変化量

RETURN LOCAL:1

@おさわりCOM_S
RESULT = 0
TCVAR:TARGET:弱点コマンドフラグ = 0
弱点コマンドカテゴリ = 
TRYCALLFORMF COMTYPE_S_%RSTR:SELECTCOM_S受け渡し%
TRYCALLFORM COM_S%RSTR:SELECTCOM_S受け渡し%
LOCAL:1 = RESULT
IF LOCAL:1 >= 0
    LOCALS = %RSTR:SELECTCOM_S受け渡し%
    IF STRFIND(コマンド初回フラグ:TARGET:0, @"-%LOCALS%-") < 0
        コマンド初回フラグ_一時保存:TARGET:0 += @"-%LOCALS%-"
    ENDIF
    IF STRFIND(コマンド初回フラグ_PLAYER:PLAYER:0, @"-%LOCALS%-") < 0
        コマンド初回フラグ_PLAYER_一時保存:PLAYER:0 += @"-%LOCALS%-"
    ENDIF
    IF STRFIND(弱点コマンドカテゴリ, "リダイレクト") >= 0
        LOCALS = %SUBSTRING(弱点コマンドカテゴリ, 12)%
    ENDIF
    ; IF 弱点コマンドカテゴリ != ""
        FOR LOCAL, 0, 50
            IF 弱点コマンド枠:TARGET:LOCAL == LOCALS
                TCVAR:TARGET:弱点コマンドフラグ = 1
                IF 弱点看破:TARGET:LOCAL == 0
                    弱点看破:TARGET:LOCAL = 1
                    弱点コマンド欄表示名 = 
                    CALLFORMF COMNAME_S%LOCALS%
                    SIF 弱点コマンド欄表示名 != ""
                        TSTR:コマンド名受渡 '= 弱点コマンド欄表示名
                    CALL 履歴データベース登録(CFLAG:MASTER:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:TARGET%は%TSTR:コマンド名受渡%に弱いとわかった</font>","うふふ")
                    CALL 履歴データベース登録(CFLAG:TARGET:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:MASTER%に%TSTR:コマンド名受渡%に弱いと知られてしまった</font>","うふふ")
                    LOCAL:4 = 0
                    LOCAL:2 = FINDLASTELEMENT(弱点コマンド枠:TARGET:0, ".")
                    FOR LOCAL:3, 0, LOCAL:2 + 1
                        SIF 弱点看破:TARGET:(LOCAL:3) == 0
                            LOCAL:4 ++
                    NEXT
                    IF LOCAL:4 == 0
                        CALL 履歴データベース登録(CFLAG:MASTER:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:TARGET%の弱点をすべて看破した</font><img src='えっちハート'>","うふふ実績")
                        CALL 履歴データベース登録(CFLAG:TARGET:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:MASTER%にすべての弱点を看破された</font><img src='えっちハート'>","うふふ実績")
                    ENDIF
                ENDIF
            ENDIF
        NEXT
    ; ENDIF
ENDIF
SPLIT RSTR:SELECTCOM_S受け渡し, "_", RESULTS
;RETURN LOCAL:1


@おさわりCOM
RESULT = 0
TCVAR:TARGET:弱点コマンドフラグ = 0
弱点コマンドカテゴリ = 
TRYCALLFORMF COMTYPE_{SELECTCOM}
TRYCALLFORM COM{SELECTCOM}
LOCAL:1 = RESULT
IF LOCAL:1 >= 0
    SELECTCASE SELECTCOM
        CASE 370 TO 374
            LOCALS = {SELECTCOM}_{NO:TARGET}
        CASE 380 TO 384
            LOCALS = {SELECTCOM}_{CFLAG:MASTER:現在マップ種別}_{CFLAG:MASTER:現在位置}
        CASE 385 TO 389
            LOCALS = {SELECTCOM}_%開催予定祭り名%
        CASE 400
            LOCALS = {SELECTCOM}
            ;追い出され・入室不可判定
            CALL 入室不可処理
        CASEELSE
            LOCALS = {SELECTCOM}
    ENDSELECT
    IF STRFIND(コマンド初回フラグ:TARGET:0, @"-%LOCALS%-") < 0
        コマンド初回フラグ_一時保存:TARGET:0 += @"-%LOCALS%-"
    ENDIF
    IF STRFIND(コマンド初回フラグ_PLAYER:PLAYER:0, @"-%LOCALS%-") < 0
        コマンド初回フラグ_PLAYER_一時保存:PLAYER:0 += @"-%LOCALS%-"
    ENDIF
    ; IF STRFIND(弱点コマンドカテゴリ, "リダイレクト") >= 0
    ; 	LOCALS = %SUBSTRING(弱点コマンドカテゴリ, 12)%
    ; ENDIF
    ; IF 弱点コマンドカテゴリ != ""
        FOR LOCAL, 0, 50
            IF 弱点コマンド枠:TARGET:LOCAL == LOCALS
                TCVAR:TARGET:弱点コマンドフラグ = 1
                IF 弱点看破:TARGET:LOCAL == 0
                    弱点看破:TARGET:LOCAL = 1
                    弱点コマンド欄表示名 = 
                    CALLFORMF COMNAME%LOCALS%
                    SIF 弱点コマンド欄表示名 != ""
                        TSTR:コマンド名受渡 '= 弱点コマンド欄表示名
                    CALL 履歴データベース登録(CFLAG:MASTER:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:TARGET%は%TSTR:コマンド名受渡%に弱いとわかった</font>","うふふ")
                    CALL 履歴データベース登録(CFLAG:TARGET:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:MASTER%に%TSTR:コマンド名受渡%に弱いと知られてしまった</font>","うふふ")
                    LOCAL:4 = 0
                    LOCAL:2 = FINDLASTELEMENT(弱点コマンド枠:TARGET:0, ".")
                    FOR LOCAL:3, 0, LOCAL:2 + 1
                        SIF 弱点看破:TARGET:(LOCAL:3) == 0
                            LOCAL:4 ++
                    NEXT
                    IF LOCAL:4 == 0
                        CALL 履歴データベース登録(CFLAG:MASTER:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:TARGET%の弱点をすべて看破した</font><img src='えっちハート'>","うふふ実績")
                        CALL 履歴データベース登録(CFLAG:TARGET:人物番号, @"<font color='#%カラーパレット_HTML("薄ピンク")%'>%CALLNAME:MASTER%にすべての弱点を看破された</font><img src='えっちハート'>","うふふ実績")
                    ENDIF
                ENDIF
            ENDIF
        NEXT
    ; ENDIF
ENDIF
;RETURN LOCAL:1

