
@一日終了時夜這い判定(対象キャラ)
#DIM 対象キャラ
#DIM 夜這い相手
#DIM 対象配列, 500
#DIM 候補配列, 500
#DIM 候補数
#DIM 関係数
#DIM 夜這い条件性欲
#DIMS 関係性種別
;0を返すとオナニー判定へ進む
;1を返すとオナニー判定はスキップする


;酔い潰れや体力０の時は夜這いしない
IF CFLAG:対象キャラ:酔いすぎ
	RETURN 0
ENDIF
IF CFLAG:対象キャラ:体力限界
	RETURN 0
ENDIF
;性知識がどっちもない場合は夜這いしない
IF MAX(知識素質:対象キャラ:性知識, 知識素質:夜這い相手:性知識) < 0
	RETURN 0
ENDIF
;通常夜這い条件
夜這い条件性欲 = 1000
SIF TALENT:対象キャラ:処女 && GETBIT(TALENT:対象キャラ:性別, 0)
	夜這い条件性欲 += 300
SIF TALENT:対象キャラ:非童貞 == 0 && GETBIT(TALENT:対象キャラ:性別, 1)
	夜這い条件性欲 -= 300
SIF TALENT:対象キャラ:自制心
	夜這い条件性欲 += TALENT:対象キャラ:自制心 * 100
SIF TALENT:対象キャラ:無関心 > 0
	夜這い条件性欲 += 100
SIF TALENT:対象キャラ:感情乏しい > 0
	夜這い条件性欲 += 150
SIF TALENT:対象キャラ:性的興味
	夜這い条件性欲 -= TALENT:対象キャラ:性的興味 * 100
SIF TALENT:対象キャラ:羞恥心
	夜這い条件性欲 += TALENT:対象キャラ:羞恥心 * 100
SIF TALENT:対象キャラ:貞操 > 0 && EXP:対象キャラ:夜這い経験 < 10
	夜這い条件性欲 += 300
SIF TALENT:対象キャラ:貞操 < 0
	夜這い条件性欲 -= 200
SIF TALENT:対象キャラ:豪快
	夜這い条件性欲 -= TALENT:対象キャラ:豪快 * 100
SIF BASE:対象キャラ:性欲 < 夜這い条件性欲
	RETURN 0

;相手の選定
VARSET 候補配列
VARSET 対象配列
候補数 = 0
関係数 = DT_SELECT("関係性データベース", @"(対象キャラ１ = {CFLAG:対象キャラ:人物番号} Or 対象キャラ２ = {CFLAG:対象キャラ:人物番号}) And (関係性種別 = '恋慕' Or 関係性種別 = 'セフレ')", , 対象配列)
IF 関係数 > 0
	FOR LOCAL, 0, 関係数
		IF DT_CELL_GETS("関係性データベース", 対象配列:LOCAL, "関係性種別", 1) == "恋慕"
			;恋慕はセフレより確率が高いので２個入れる
			LOCAL:1 = 関係性_相手人物番号取得(CFLAG:対象キャラ:人物番号, 対象配列:LOCAL)
			夜這い相手 = FIND_CHARA_FROM_PERSON_ID(LOCAL:1)
			;既に夜這いしてるか対象になってる相手はキャンセル
			SIF TCVAR:夜這い相手:夜這い済み
				CONTINUE
			;島にいない相手は当然ダメ
			SIF CFLAG:夜這い相手:滞在期間 < 0
				CONTINUE
			IF LOCAL:1 > 0
				候補配列:候補数 = LOCAL:1
				候補数 ++
				候補配列:候補数 = LOCAL:1
				候補数 ++
			ENDIF
		ELSE
			;セフレ
			LOCAL:1 = 関係性_相手人物番号取得(CFLAG:対象キャラ:人物番号, 対象配列:LOCAL)
			夜這い相手 = FIND_CHARA_FROM_PERSON_ID(LOCAL:1)
			;既に夜這いしてるか対象になってる相手はキャンセル
			SIF TCVAR:夜這い相手:夜這い済み
				CONTINUE
			;島にいない相手は当然ダメ
			SIF CFLAG:夜這い相手:滞在期間 < 0
				CONTINUE
			IF LOCAL:1 > 0
				候補配列:候補数 = LOCAL:1
				候補数 ++
			ENDIF
		ENDIF
	NEXT
ENDIF
IF TALENT:対象キャラ:恋慕 && TCVAR:MASTER:夜這い済み == 0
	候補配列:候補数 = CFLAG:MASTER:人物番号
	候補数 ++
	候補配列:候補数 = CFLAG:MASTER:人物番号
	候補数 ++
ENDIF
IF TALENT:対象キャラ:セフレ && TCVAR:MASTER:夜這い済み == 0
	候補配列:候補数 = CFLAG:MASTER:人物番号
	候補数 ++
ENDIF
IF 候補数 < 1
	RETURN 0
ENDIF

;ランダムに決定
夜這い相手 = FIND_CHARA_FROM_PERSON_ID(候補配列:(RAND:候補数))
IF 夜這い相手 == MASTER
	IF TALENT:対象キャラ:恋慕
		関係性種別 = 恋慕
	ELSE
		関係性種別 = セフレ
	ENDIF
ELSE
	IF MATCH(候補配列, CFLAG:夜這い相手:人物番号) > 1
		関係性種別 = 恋慕
	ELSE
		関係性種別 = セフレ
	ENDIF
ENDIF

DRAWLINE
IF BASE:対象キャラ:性欲 >= 夜這い条件性欲
	PRINTFORML %CALLNAME:対象キャラ%は性欲が溜まり、むらむらとした気分になっている
	IF EXP:対象キャラ:夜這い経験 < 10 && TALENT:対象キャラ:経験豊富 == 0 && RAND:2
		;夜這い経験がないとまごまごする
		PRINTFORML しかし、夜這いをする勇気が出ないようだ……
		PRINTFORMW しばらく%CALLNAME:夜這い相手%の部屋の前でまごまごした後、自分の部屋へと帰っていった。
		RETURN 0
	ENDIF
ENDIF
PRINTFORM %CALLNAME:対象キャラ%は
IF 関係性種別 == "恋慕"
	PRINT 恋人の
ELSE
	PRINT セフレ相手の
ENDIF
PRINTFORML %CALLNAME:夜這い相手%の部屋を訪れ、熱い夜を過ごした……
PRINTL
;受け攻め設定を取り出す
DT_SELECT "関係性データベース", @"(対象キャラ１ = {CFLAG:対象キャラ:人物番号} Or 対象キャラ２ = {CFLAG:対象キャラ:人物番号}) And (対象キャラ１ = {CFLAG:夜這い相手:人物番号} Or 対象キャラ２ = {CFLAG:夜這い相手:人物番号})"
CALL 夜這い実処理(対象キャラ, 夜這い相手, RESULT:1)
;実行処理の後に口上表示
PRINTW
RETURN 1


@夜這い実処理(実行キャラ, 夜這い相手, 配列id)
#DIM 実行キャラ
#DIM 実行キャラ_快楽基礎値
#DIM 夜這い相手
#DIM 夜這い相手_快楽基礎値
#DIM 対象キャラ
#DIM 対象キャラ_快楽基礎値
#DIM 相手キャラ
#DIM 相手キャラ_快楽基礎値
#DIM ZP量保存, 3
#DIM 絶頂保存
#DIM 配列id
#DIM 逆フラグ
#DIM リンクキャラ
#DIMS EXP計算フラグ

VARSET ZP量保存
;両者とも各部位に経験と絶頂を付与する
;そのために基礎値を算出

実行キャラ_快楽基礎値 = 1 + ABL:夜這い相手:技巧 + ABL:夜這い相手:指テク + ABL:夜這い相手:舌技
夜這い相手_快楽基礎値 = 1 + ABL:実行キャラ:技巧 + ABL:実行キャラ:指テク + ABL:実行キャラ:舌技

;性別ごとに部位に経験を付与

;まずは組み合わせ不問で発生する愛撫関連
FOR LOCAL, 0, 2
	;処理を共通させるために入れ替えながら汎用処理
	IF LOCAL == 0
		対象キャラ = 実行キャラ
		対象キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
		相手キャラ = 夜這い相手
	ELSE
		対象キャラ = 夜這い相手
		対象キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
		相手キャラ = 実行キャラ
	ENDIF

	;愛撫B関連
	IF TALENT:対象キャラ:Ｂ感度 != -2
		;女の時と男の時とで分岐
		IF GETBIT(TALENT:対象キャラ:性別, 0)
			EXP:対象キャラ:Ｂ経験 += 対象キャラ_快楽基礎値 * 2
			絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｂ感覚 * 2) / 3
			EXP:対象キャラ:Ｂ絶頂経験 += 絶頂保存
			EXP:対象キャラ:乳首開発 += 対象キャラ_快楽基礎値
		ELSE
			EXP:対象キャラ:Ｂ経験 += 対象キャラ_快楽基礎値 / 3
			絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｂ感覚 * 2) / 10
			EXP:対象キャラ:Ｂ絶頂経験 += 絶頂保存
			EXP:対象キャラ:乳首開発 += 対象キャラ_快楽基礎値 / 3
		ENDIF
		IF TALENT:対象キャラ:母乳体質
			EXP:対象キャラ:噴乳経験 += 絶頂保存
		ENDIF
		BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
		EXP:対象キャラ:絶頂経験 += 絶頂保存
		JUEL:対象キャラ:快Ｂ += 絶頂保存 * 10
		ZP量保存:LOCAL += 絶頂保存
	ENDIF

	;愛撫C関連
	IF TALENT:対象キャラ:Ｃ感度 != -2
		;ちんこがあるかないかで分岐
		IF GETBIT(TALENT:対象キャラ:性別, 1)
			EXP:対象キャラ:Ｃ経験 += 対象キャラ_快楽基礎値 * 2
			絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｃ感覚 * 2) / 2
			EXP:対象キャラ:Ｃ絶頂経験 += 絶頂保存
			EXP:対象キャラ:射精経験 += 絶頂保存
		ELSE
			EXP:対象キャラ:Ｃ経験 += 対象キャラ_快楽基礎値 * 2
			絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｃ感覚 * 2) / 2
			EXP:対象キャラ:Ｃ絶頂経験 += 絶頂保存
		ENDIF
		BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
		EXP:対象キャラ:絶頂経験 += 絶頂保存
		JUEL:対象キャラ:快Ｃ += 絶頂保存 * 10
		ZP量保存:LOCAL += 絶頂保存
	ENDIF

	;愛撫V関連
	IF TALENT:対象キャラ:Ｖ感度 != -2 && GETBIT(TALENT:対象キャラ:性別, 0)
		EXP:対象キャラ:Ｖ経験 += MAX(1, 対象キャラ_快楽基礎値 * 2 - TALENT:対象キャラ:処女 * 5)
		絶頂保存 = MAX(0, (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｖ感覚 * 2) / 2 - TALENT:対象キャラ:処女 * 3)
		EXP:対象キャラ:Ｖ絶頂経験 += 絶頂保存
		EXP:対象キャラ:絶頂経験 += 絶頂保存
		JUEL:対象キャラ:快Ｖ += 絶頂保存 * 10
		ZP量保存:LOCAL += 絶頂保存
		BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
	ENDIF

	;愛撫A関連
	;両方にA経験がないなら発動しない
	IF TALENT:対象キャラ:Ａ感度 != -2 && (EXP:対象キャラ:Ａ経験 > 0 && EXP:相手キャラ:Ａ経験 > 0)
		EXP:対象キャラ:Ａ経験 += 対象キャラ_快楽基礎値 * 2
		絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ａ感覚 * 2) / 2
		EXP:対象キャラ:Ａ絶頂経験 += 絶頂保存
		EXP:対象キャラ:絶頂経験 += 絶頂保存
		JUEL:対象キャラ:快Ａ += 絶頂保存 * 10
		ZP量保存:LOCAL += 絶頂保存
		BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
	ENDIF
NEXT

;次に組み合わせが必要な性交関連
;ちんこなし組み合わせの場合、性知識とアイテムが必要
IF GETBIT(TALENT:対象キャラ:性別, 1) == 0 && GETBIT(TALENT:夜這い相手:性別, 1) == 0
	SIF MAX(知識素質:対象キャラ:性知識, 知識素質:夜這い相手:性知識) < 1
		RETURN 0
ENDIF

;基礎値に追加
実行キャラ_快楽基礎値 += ABL:夜這い相手:腰使い
夜這い相手_快楽基礎値 += ABL:実行キャラ:腰使い
;受け攻めを確定
IF GETBIT(TALENT:実行キャラ:性別, 1) != GETBIT(TALENT:夜這い相手:性別, 1)
	;ちんこありANDなしの組み合わせの場合、ありが攻め・なしが受け固定
	IF GETBIT(TALENT:実行キャラ:性別, 1) == 0
		;対象＝受け
		対象キャラ = 実行キャラ
		対象キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
		;相手＝攻め
		相手キャラ = 夜這い相手
		相手キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
		逆フラグ = 1
	ELSE
		対象キャラ = 夜這い相手
		対象キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
		相手キャラ = 実行キャラ
		相手キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
	ENDIF
ELSE
	;男女以外の場合、受け攻め設定を見る
	SELECTCASE DT_CELL_GETS("関係性データベース", 配列id, "受け攻め設定", 1)
		CASE ""
			IF RAND:2
				;対象＝受け
				対象キャラ = 実行キャラ
				対象キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
				;相手＝攻め
				相手キャラ = 夜這い相手
				相手キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				逆フラグ = 1
			ELSE
				;対象＝受け
				対象キャラ = 夜這い相手
				対象キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				;相手＝攻め
				相手キャラ = 実行キャラ
				相手キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
			ENDIF
		CASE "順"
			IF CFLAG:実行キャラ:人物番号 == DT_CELL_GET("関係性データベース", 配列id, "対象キャラ１", 1)
				;対象＝受け
				対象キャラ = 夜這い相手
				対象キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				;相手＝攻め
				相手キャラ = 実行キャラ
				相手キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
			ELSE
				;対象＝受け
				対象キャラ = 実行キャラ
				対象キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
				;相手＝攻め
				相手キャラ = 夜這い相手
				相手キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				逆フラグ = 1
			ENDIF
		CASE "逆"
			IF CFLAG:実行キャラ:人物番号 == DT_CELL_GET("関係性データベース", 配列id, "対象キャラ１", 1)
				;対象＝受け
				対象キャラ = 実行キャラ
				対象キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
				;相手＝攻め
				相手キャラ = 夜這い相手
				相手キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				逆フラグ = 1
			ELSE
				;対象＝受け
				対象キャラ = 夜這い相手
				対象キャラ_快楽基礎値 = 夜這い相手_快楽基礎値
				;相手＝攻め
				相手キャラ = 実行キャラ
				相手キャラ_快楽基礎値 = 実行キャラ_快楽基礎値
			ENDIF
	ENDSELECT
ENDIF
;V快楽算出処理
IF GETBIT(TALENT:対象キャラ:性別, 0) && TALENT:対象キャラ:Ｖ感度 != -2
	EXP:対象キャラ:Ｖ経験 += MAX(1, 対象キャラ_快楽基礎値 * 2 - TALENT:対象キャラ:処女 * 5)
	EXP:対象キャラ:Ｖ性交経験 += MAX(1, 対象キャラ_快楽基礎値 * 2 - TALENT:対象キャラ:処女 * 5)
	絶頂保存 = MAX(0, (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ｖ感覚 * 2) / 2 - TALENT:対象キャラ:処女 * 3)
	EXP:対象キャラ:Ｖ絶頂経験 += 絶頂保存
	EXP:対象キャラ:絶頂経験 += 絶頂保存
	JUEL:対象キャラ:快Ｖ += 絶頂保存 * 10
	IF 逆フラグ
		ZP量保存:0 += 絶頂保存
	ELSE
		ZP量保存:1 += 絶頂保存
	ENDIF
	BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
	;処女喪失
	CALL LOST_VIRGIN(対象キャラ, 相手キャラ, 1)
	CALL LOST_MAN_VIRGIN(相手キャラ, 対象キャラ, 1)
	;ちんこがあるかないかで分岐
	IF GETBIT(TALENT:対象キャラ:性別, 1)
		EXP:相手キャラ:Ｃ経験 += 相手キャラ_快楽基礎値 * 2
		EXP:相手キャラ:Ｃ性交経験_Ｖ挿入 += 相手キャラ_快楽基礎値 * 2
		絶頂保存 = (相手キャラ_快楽基礎値 + ABL:相手キャラ:Ｃ感覚 * 2) / 2
		EXP:相手キャラ:Ｃ絶頂経験 += 絶頂保存
		EXP:相手キャラ:射精経験 += 絶頂保存
		EXP:対象キャラ:精液経験 += 絶頂保存
		BASE:相手キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 10))
		IF 逆フラグ
			ZP量保存:1 += 絶頂保存
		ELSE
			ZP量保存:0 += 絶頂保存
		ENDIF
		IF 性癖素質:対象キャラ:膣内射精
			EXP:対象キャラ:Ｖ絶頂経験 += 絶頂保存 * 性癖素質:対象キャラ:膣内射精
			EXP:対象キャラ:絶頂経験 += 絶頂保存 * 性癖素質:対象キャラ:膣内射精
			IF 逆フラグ
				ZP量保存:0 += 絶頂保存 * 性癖素質:対象キャラ:膣内射精
			ELSE
				ZP量保存:1 += 絶頂保存 * 性癖素質:対象キャラ:膣内射精
			ENDIF
			BASE:対象キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 性癖素質:対象キャラ:膣内射精 * 10))
		ENDIF
	ELSEIF TALENT:対象キャラ:Ｖ感度 != -2
		;ないならペニバン
		EXP:相手キャラ:Ｖ経験 += 相手キャラ_快楽基礎値 * 2
		絶頂保存 = (相手キャラ_快楽基礎値 + ABL:相手キャラ:Ｖ感覚 * 2) / 2
		EXP:相手キャラ:Ｖ絶頂経験 += 絶頂保存
		BASE:相手キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 10))
		IF 逆フラグ
			ZP量保存:1 += 絶頂保存
		ELSE
			ZP量保存:0 += 絶頂保存
		ENDIF
	ENDIF
ENDIF
;A快楽算出処理
;A経験が両方低いないなら発動しない
IF TALENT:対象キャラ:Ａ感度 != -2 && MAX(EXP:対象キャラ:Ａ経験, EXP:相手キャラ:Ａ経験) > 50
	EXP:対象キャラ:Ａ経験 += 対象キャラ_快楽基礎値 * 2
	EXP:対象キャラ:Ａ性交経験 += 対象キャラ_快楽基礎値 * 2
	絶頂保存 = (対象キャラ_快楽基礎値 + ABL:対象キャラ:Ａ感覚 * 2) / 2
	EXP:対象キャラ:Ａ絶頂経験 += 絶頂保存
	EXP:対象キャラ:絶頂経験 += 絶頂保存
	JUEL:対象キャラ:快Ａ += 絶頂保存 * 10
	BASE:対象キャラ:性欲 = MAX(0, BASE:対象キャラ:性欲 - (絶頂保存 * 10))
	IF 逆フラグ
		ZP量保存:0 += 絶頂保存
	ELSE
		ZP量保存:1 += 絶頂保存
	ENDIF
	;Ａ童貞喪失
	CALL LOST_MAN_VIRGIN(相手キャラ, 対象キャラ, 2)
	;ちんこがあるかないかで分岐
	IF GETBIT(TALENT:対象キャラ:性別, 1)
		EXP:相手キャラ:Ｃ経験 += 相手キャラ_快楽基礎値 * 2
		EXP:相手キャラ:Ｃ性交経験_Ａ挿入 += 相手キャラ_快楽基礎値 * 2
		絶頂保存 = (相手キャラ_快楽基礎値 + ABL:相手キャラ:Ｃ感覚 * 2) / 2
		EXP:相手キャラ:Ｃ絶頂経験 += 絶頂保存
		EXP:相手キャラ:射精経験 += 絶頂保存
		EXP:対象キャラ:精液経験 += 絶頂保存
		BASE:相手キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 10))
		IF 逆フラグ
			ZP量保存:1 += 絶頂保存
		ELSE
			ZP量保存:0 += 絶頂保存
		ENDIF
		IF 性癖素質:対象キャラ:腸内射精
			EXP:対象キャラ:Ｖ絶頂経験 += 絶頂保存 * 性癖素質:対象キャラ:腸内射精
			EXP:対象キャラ:絶頂経験 += 絶頂保存 * 性癖素質:対象キャラ:腸内射精
			BASE:対象キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 性癖素質:対象キャラ:腸内射精 * 10))
			IF 逆フラグ
				ZP量保存:0 += 絶頂保存 * 性癖素質:対象キャラ:腸内射精
			ELSE
				ZP量保存:1 += 絶頂保存 * 性癖素質:対象キャラ:腸内射精
			ENDIF
		ENDIF
	ELSEIF TALENT:対象キャラ:Ｖ感度 != -2
		;ないならペニバン
		EXP:相手キャラ:Ｖ経験 += 相手キャラ_快楽基礎値 * 2
		絶頂保存 = (相手キャラ_快楽基礎値 + ABL:相手キャラ:Ｖ感覚 * 2) / 2
		EXP:相手キャラ:Ｖ絶頂経験 += 絶頂保存
		BASE:相手キャラ:性欲 = MAX(0, BASE:相手キャラ:性欲 - (絶頂保存 * 10))
		IF 逆フラグ
			ZP量保存:1 += 絶頂保存
		ELSE
			ZP量保存:0 += 絶頂保存
		ENDIF
	ENDIF
ENDIF

;-------------------------------------------------
;経験表示
;-------------------------------------------------
EXP計算フラグ = 
FOR LOCAL, 0, 2
	IF LOCAL == 0
		対象キャラ = 実行キャラ
	ELSE
		対象キャラ = 夜這い相手
	ENDIF
	FOR LOCAL:1, 0, 200
		IF EXP_UP(LOCAL:1, 対象キャラ)
			LOCAL:2 ++
			SIF LOCAL:2 == 1
				PRINTL
			LOCALS = %EXPNAME:(LOCAL:1)%
			PRINTFORM %LOCALS,15,LEFT%
			LOCALS = +{EXP_UP(LOCAL:1, 対象キャラ)}
			PRINTFORML %LOCALS,4,LEFT%(%CALLNAME:対象キャラ%)

			;命のリンクを個別処理
			IF TALENT:対象キャラ:命のリンク && LOCAL:1 <= 12
				IF NO:対象キャラ != 27
					リンクキャラ = FINDCHARA(NO, 27)
					IF TALENT:リンクキャラ:命のリンク && CFLAG:リンクキャラ:滞在期間 > 0 && リンクキャラ != 実行キャラ && リンクキャラ != 夜這い相手
						EXP:リンクキャラ:(LOCAL:1) += EXP_UP(LOCAL:1, 対象キャラ)
						SIF STRFIND(EXP計算フラグ, @"{リンクキャラ}_") != 0 && STRFIND(EXP計算フラグ, @"_{リンクキャラ}_") == -1
							EXP計算フラグ += @"{リンクキャラ}_"
					ENDIF
				ENDIF
				IF NO:対象キャラ != 28
					リンクキャラ = FINDCHARA(NO, 28)
					IF TALENT:リンクキャラ:命のリンク && CFLAG:リンクキャラ:滞在期間 > 0 && リンクキャラ != 実行キャラ && リンクキャラ != 夜這い相手
						EXP:リンクキャラ:(LOCAL:1) += EXP_UP(LOCAL:1, 対象キャラ)
						SIF STRFIND(EXP計算フラグ, @"{リンクキャラ}_") != 0 && STRFIND(EXP計算フラグ, @"_{リンクキャラ}_") == -1
							EXP計算フラグ += @"{リンクキャラ}_"
					ENDIF
				ENDIF
				IF NO:対象キャラ != 146
					リンクキャラ = FINDCHARA(NO, 146)
					IF TALENT:リンクキャラ:命のリンク && CFLAG:リンクキャラ:滞在期間 > 0 && リンクキャラ != 実行キャラ && リンクキャラ != 夜這い相手
						EXP:リンクキャラ:(LOCAL:1) += EXP_UP(LOCAL:1, 対象キャラ)
						SIF STRFIND(EXP計算フラグ, @"{リンクキャラ}_") != 0 && STRFIND(EXP計算フラグ, @"_{リンクキャラ}_") == -1
							EXP計算フラグ += @"{リンクキャラ}_"
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	NEXT
	LOCAL:2 = 0
NEXT

CALL EXP変動記録処理(実行キャラ)
CALL EXP変動記録処理(夜這い相手)

LOCALS:1 = 
IF EXP計算フラグ != ""
	VARSET RESULTS
	SPLIT EXP計算フラグ, "_", RESULTS
	FOR LOCAL, 0, RESULT
		リンクキャラ = TOINT(RESULTS:LOCAL)
		FOR LOCAL:1, 0, 20
			IF EXP_UP(LOCAL:1, リンクキャラ)
				LOCAL:2 ++
				SIF LOCAL:2 == 1
					PRINTL
				LOCALS = %EXPNAME:(LOCAL:1)%
				PRINTFORM %LOCALS,15,LEFT%
				LOCALS = +{EXP_UP(LOCAL:1, リンクキャラ)}
				PRINTFORML %LOCALS,4,LEFT%(%CALLNAME:リンクキャラ%)
				IF LOCAL:1 == 10
					;絶頂経験をZPに投げる
					LOCALS:1 += @" + {EXP_UP(LOCAL:1, リンクキャラ)}(%CALLNAME:リンクキャラ%)"
					ZP量保存:2 += EXP_UP(LOCAL:1, リンクキャラ)
				ENDIF
			ENDIF
		NEXT
	NEXT
	CALL EXP変動記録処理(リンクキャラ)
ENDIF

;-------------------------------------------------
;ZPの取得量表示
;-------------------------------------------------
IF MAX(ZP量保存:0, ZP量保存:1) > 0
	PRINTL
	PRINTFORM ZP:{FLAG:ZP所持量}
	IF ZP量保存:0
		IF 実行キャラ == MASTER
			ZP量保存:0 = 0
		ELSE
			PRINTFORM  + {ZP量保存:0}(%CALLNAME:実行キャラ%)
		ENDIF
	ENDIF
	IF ZP量保存:1
		IF 夜這い相手 == MASTER
			ZP量保存:1 = 0
		ELSE
			PRINTFORM  + {ZP量保存:1}(%CALLNAME:夜這い相手%)
		ENDIF
	ENDIF
	IF ZP量保存:2
		PRINTFORM %LOCALS:1%
	ENDIF
	FLAG:ZP所持量 += ZP量保存:0 + ZP量保存:1 + ZP量保存:2
	PRINTFORML = {FLAG:ZP所持量}
ENDIF

;フラグ建て
TCVAR:実行キャラ:夜這い済み = 1
TCVAR:夜這い相手:夜這い済み = 1
EXP:実行キャラ:夜這い経験 += 1


