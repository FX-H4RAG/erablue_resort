
@固有奥義_63(ARGS, キャラ番号)
#DIM キャラ番号
#DIM 奥義威力
#DIMS 奥義名
#DIM 再発動対象
#DIM 対象キャラ
#DIM 三日月
#DIM 望
#DIM 月相
#DIM 月狂の涙
#DIM 月判定
#DIM 月狂の鏡光

月狂の鏡光 = バフ存在チェック_枠("月狂の鏡光", 戦闘行動キャラ) 
再発動対象 = アビテンプレート用_対象保存:0

月判定 = 0

IF 陥落チェック(キャラ番号) && 基礎BATTLE_STATE:キャラ番号:Lv >= 70
	奥義名 = イルジオン・フォルモーント
	奥義威力 = 500
ELSE
	奥義名 = モーントリヒト
	奥義威力 = 450
ENDIF
	
月判定 = 0
	
FOR 対象キャラ, 0, 4
	IF バフ存在チェック_枠("三日月", 対象キャラ) < 0 || バフ存在チェック_枠("上弦", 対象キャラ) < 0 || バフ存在チェック_枠("望", 対象キャラ) < 0
		月判定 = 1
		戦闘中カウント:戦闘行動キャラ:0 = 0
		BREAK
	ENDIF
NEXT

SELECTCASE ARGS
	CASE "奥義名"
		TSTR:コマンド名受渡 = %奥義名%
	CASE "奥義説明文"
		IF 陥落チェック(キャラ番号) && 基礎BATTLE_STATE:キャラ番号:Lv >= 70
			詳細文文字列受け渡し変数 = 奥義威力：{奥義威力}％<br>味方全体に月効果［7ターン/消去不可］
			詳細文文字列受け渡し変数 += @"<br>完全に満ちた月を1ターン延長"
			詳細文文字列受け渡し変数 += @"<br>自身のMPを［100］回復"
		ELSE
			詳細文文字列受け渡し変数 = 奥義威力：{奥義威力}％<br>味方全体に月効果［5ターン/消去不可］
			詳細文文字列受け渡し変数 += @"<br>自身のMPを［100］回復"
		ENDIF
		RETURN 奥義威力
	CASE "奥義前効果"
		;対象決定の後、ダメージよりも前に発生する効果。基本の奥義ダメージ部分は記載する必要はない。
		;奥義威力が0だとここの部分もスキップされる
	CASE "奥義追加効果"
		CALL アビ対象選択テンプレート_指定(再発動対象)
		
		IF 月判定 == 1
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_味方全体_生者のみ
			アビ汎用文字列:バフ・デバフ枠 = 三日月
			アビ汎用文字列:バフ・デバフ対象能力 = 三日月
			アビ汎用変数:効果割合 = 0
			IF 陥落チェック(キャラ番号) && 基礎BATTLE_STATE:キャラ番号:Lv >= 70
				アビ汎用変数:持続ターン = 7
			ELSE
				アビ汎用変数:持続ターン = 5
			ENDIF
			アビ汎用変数:消去不可オプション = 1
			アビ汎用変数:特殊表示オプション = 1
			CALL アビテンプレート_有利効果_バフ効果セット
			
			戦闘中カウント:戦闘行動キャラ:0 = 1
			
			FOR 対象キャラ, 0, 4
				三日月 = バフ存在チェック_枠("三日月", 対象キャラ)
				望 = バフ存在チェック_枠("望", 対象キャラ)
				月相 = DT_CELL_GET(@"デバフデータベース_{戦闘行動キャラ}", 望, "持続ターン")
				
				月狂の涙 = バフ存在チェック_枠("月狂の涙", 戦闘行動キャラ)
				
				DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "望_攻撃力", "バフ対象能力", "攻撃力", "バフ効果量_割合", (戦闘中カウント:戦闘行動キャラ:0 * 5) + 10, "バフ名", "月", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 三日月, "持続ターン"), "消去不可フラグ", 1
				DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "望_防御力", "バフ対象能力", "防御力", "バフ効果量_割合", (戦闘中カウント:戦闘行動キャラ:0 * 5) + 10, "バフ名", "月", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 三日月, "持続ターン"), "消去不可フラグ", 1
				
				IF 月狂の涙 > -1
					DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "月狂の涙_DA率", "バフ対象能力", "DA率", "バフ効果量_固定値", 100, "バフ名", "月狂の涙", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 月狂の涙, "持続ターン")
					DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "月狂の涙_TA率", "バフ対象能力", "TA率", "バフ効果量_固定値", 20, "バフ名", "月狂の涙", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 月狂の涙, "持続ターン")
				ENDIF
				
				DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "月海の羽衣_防御力", "バフ対象能力", "防御力", "バフ効果量_割合", 20, "バフ名", "月海の羽衣", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 三日月, "持続ターン"), "消去不可フラグ", 1
				
				IF 陥落チェック(63) && 基礎BATTLE_STATE:キャラ番号:Lv >= 80
					DT_ROW_ADD @"バフデータベース_{対象キャラ}", "バフ枠", "月の映鏡", "バフ対象能力", "追撃", "バフ効果量_割合", 20, "バフ名", "月の映鏡", "持続ターン", DT_CELL_GET(@"バフデータベース_{対象キャラ}", 三日月, "持続ターン"), "消去不可フラグ", 1
				ENDIF
			NEXT
		ENDIF
		
		IF 望 > -1 && 陥落チェック(キャラ番号) && 基礎BATTLE_STATE:キャラ番号:Lv >= 70
			FOR 対象キャラ, 0, 4
				DT_CELL_SET @"バフデータベース_{対象キャラ}", 望, "持続ターン", 月相 + 1
			NEXT
		ENDIF
		
		CALL アビ汎用変数文字列リセット
		CALL アビ対象選択テンプレート_自己のみ
		アビ汎用変数:効果量 = 50
		CALL アビテンプレート_ＭＰ回復処理_MAXでも回復
		
		IF 月狂の鏡光 > -1
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_指定(再発動対象)
			アビ汎用変数:効果割合 = 450
			CALL アビテンプレート_ダメージ処理_水属性
			
			IF 望 > -1 && 陥落チェック(キャラ番号) && 基礎BATTLE_STATE:キャラ番号:Lv >= 70
				FOR 対象キャラ, 0, 4
					DT_CELL_SET @"バフデータベース_{対象キャラ}", 望, "持続ターン", 月相 + 1
				NEXT
			ENDIF
			
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_自己のみ
			アビ汎用変数:効果量 = 50
			CALL アビテンプレート_ＭＰ回復処理_MAXでも回復
		ENDIF
ENDSELECT

