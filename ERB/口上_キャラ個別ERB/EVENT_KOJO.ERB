;--------------------------------------------------
;@KOJO_MESSAGE_COM関係
;コマンド実行時に出力されます
;--------------------------------------------------
@KOJO_MESSAGE_COM
#DIMS 呼び出し文字列
#DIM 対象キャラ
#DIM 入れ替え保存

IF 自慰ターゲット保存 > -1
	入れ替え保存 = TARGET
	TARGET = 自慰ターゲット保存
ENDIF

VARSET LOCAL
IF FLAG:汎用文章表示切り替えオプション > 0
	IF TCVAR:TARGET:弱点コマンドフラグ
		DRAWLINE
		SETCOLOR カラーパレット("えっちな色")
		PRINTW <<<弱点コマンド！！>>>
		RESETCOLOR
	ENDIF
	CALL TRAIN_MESSAGE
	SIF RESULT
		PRINTW
	PRINTL
ENDIF
IF FLAG:口上表示切り替えオプション <= 0
	RETURN 0
ENDIF

CALL 口上変数初期化
RESULT = 0
;RESULTS =
;口上の存在判定 and RESULTSに文字列代入
;TRYCALLFORM KOJO_K{NO:TARGET}
;IF !RESULT
;	RETURN 0
;ENDIF
;RESULT = 0
;ボールギャグ
; IF TEQUIP:ボールギャグ && SELECTCOM != 106
; 	TRYCALLFORM KOJO_COM_BALLGAG_K{NO:TARGET}
;SELECTCOM

;口上ありでも汎用喘ぎを使うならここで表示
IF TFLAG:オートコマンドフラグ == 0
	対象キャラ = TARGET
	IF CFLAG:対象キャラ:汎用喘ぎ禁止フラグ == -1
		CALL 汎用喘ぎ処理(対象キャラ)
	ELSEIF CFLAG:対象キャラ:汎用喘ぎ禁止フラグ == 1
		;禁止時はなにもしない
	ELSE
		IF TALENT:対象キャラ:性別 == 2
			SIF GETBIT(汎用喘ぎ使用OPTION_男, 0) && GETBIT(汎用喘ぎ使用OPTION_男, 1)
				CALL 汎用喘ぎ処理(対象キャラ)
		ELSE
			SIF GETBIT(汎用喘ぎ使用OPTION, 0) && GETBIT(汎用喘ぎ使用OPTION, 1)
				CALL 汎用喘ぎ処理(対象キャラ)
		ENDIF
	ENDIF
ENDIF

SIF TCVAR:TARGET:食いしばりフラグ
	SKIPDISP 1

RESULT = 0
;まずオートコマンドとサイドボタン時をふるい分け
IF RFLAG:サイドボタン操作
ELSEIF TFLAG:オートコマンドフラグ >= 3000
	;自慰パターンだけ特殊処理
	IF TFLAG:オートコマンドフラグ - 3000 == 9
		LOCALS = {TFLAG:オートコマンドフラグ - 3000}_%AUTOCOM_派生保存%
		TRYCALLFORM KOJO_COM_{NO:自慰ターゲット保存}_%LOCALS%(自慰ターゲット保存)
	ELSE
		LOCAL = TARGET
		TARGET = PLAYER
		PLAYER = AUTOCOM_相手番号保存
		LOCALS = 
		IF AUTOCOM_派生保存 != ""
			LOCALS = {TFLAG:オートコマンドフラグ - 3000}_%AUTOCOM_派生保存%
		ELSE
			LOCALS = {TFLAG:オートコマンドフラグ - 3000}
		ENDIF
		TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_%LOCALS%(PLAYER)
		TRYCALLFORM KOJO_COM_{NO:TARGET}_%LOCALS%(TARGET)
		PLAYER = TARGET
		TARGET = LOCAL
	ENDIF
ELSEIF TFLAG:オートコマンドフラグ > 2000
	TRYCALLFORM KOJO_ALLAUTOCOM_{NO:AUTOCOM_相手番号保存}_{TFLAG:オートコマンドフラグ - 2000}(AUTOCOM_相手番号保存)
ELSEIF TFLAG:オートコマンドフラグ > 1000
	TRYCALLFORM KOJO_AUTOCOM_{NO:AUTOCOM_相手番号保存}_{TFLAG:オートコマンドフラグ - 1000}(AUTOCOM_相手番号保存)
ELSEIF TFLAG:オートコマンドフラグ > 0
	TRYCALLFORM KOJO_PREAUTOCOM_{NO:AUTOCOM_相手番号保存}_{TFLAG:オートコマンドフラグ}(AUTOCOM_相手番号保存)
ELSEIF TFLAG:オートコマンドフラグ == -1
	SELECTCASE RFLAG:コマンド結果受渡し変数
		CASE 0
			;自宅で遊ぶ
			SELECTCASE RFLAG:コマンド結果受渡し変数２
				CASE 0
					;許可
					TRYCALLFORM KOJO_EVENT_自室訪問承諾_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
				CASE 1
					;簡易許可
					TRYCALLFORM KOJO_EVENT_自室訪問簡易承諾_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
				CASE 2
					;断る
					TRYCALLFORM KOJO_EVENT_自室訪問断り_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
			ENDSELECT
		CASE 1
			;遊びに誘う
			SELECTCASE RFLAG:コマンド結果受渡し変数２
				CASE 0
					;許可
					TRYCALLFORM KOJO_EVENT_遊びの誘い承諾_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
				CASE 1
					;簡易許可
					TRYCALLFORM KOJO_EVENT_遊びの誘い簡易承諾_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
				CASE 2
					;断る
					TRYCALLFORM KOJO_EVENT_遊びの誘い断り_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
			ENDSELECT
		CASE 2
			;仕事の用事
			TRYCALLFORM KOJO_EVENT_仕事訪問_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
		CASE 3
			;うふふお誘い
			SELECTCASE RFLAG:コマンド結果受渡し変数２
				CASE 0
					;許可
					TRYCALLFORM KOJO_EVENT_うふふ誘い承諾_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
				CASE 2
					;断る
					TRYCALLFORM KOJO_EVENT_うふふ誘い断り_{NO:AUTOCOM_相手番号保存}(AUTOCOM_相手番号保存)
			ENDSELECT
	ENDSELECT
ELSE
	;オートじゃないなら指示モード口上を見る
	IF FLAG:モード管理 == 1
		IF RSTR:SELECTCOM_S受け渡し != ""
			TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_%RSTR:SELECTCOM_S受け渡し%(PLAYER)
		ELSEIF SELECTCOM >= 380 && SELECTCOM <= 384
			TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_{SELECTCOM}_{CFLAG:MASTER:現在マップ種別}_{CFLAG:MASTER:現在位置}(PLAYER)
		ELSEIF SELECTCOM >= 385 && SELECTCOM <= 389
			TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_{SELECTCOM}_%開催予定祭り名%(PLAYER)
		ELSEIF SELECTCOM >= 370 && SELECTCOM <= 374
			TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_{SELECTCOM}_{NO:TARGET}(PLAYER)
		ELSE
			TRYCALLFORM KOJO_COMPLAYER_{NO:PLAYER}_{SELECTCOM}(PLAYER)
		ENDIF
	ENDIF
	IF 自慰ターゲット保存 > -1
		;自慰パターンだけ特殊処理
		TRYCALLFORM KOJO_COM_{NO:自慰ターゲット保存}_%RSTR:SELECTCOM_S受け渡し%(自慰ターゲット保存)
	ELSEIF RSTR:SELECTCOM_S受け渡し != ""
		TRYCALLFORM KOJO_COM_{NO:TARGET}_%RSTR:SELECTCOM_S受け渡し%(TARGET)
		IF FLAG:モード管理 == 2
			呼び出し文字列 = %RSTR:SELECTCOM_S受け渡し%
		ENDIF
	ELSEIF SELECTCOM >= 380 && SELECTCOM <= 384
		TRYCALLFORM KOJO_COM_{NO:TARGET}_{SELECTCOM}_{CFLAG:MASTER:現在マップ種別}_{CFLAG:MASTER:現在位置}(TARGET)
		IF FLAG:モード管理 == 2
			呼び出し文字列 = {SELECTCOM}_{CFLAG:MASTER:現在マップ種別}_{CFLAG:MASTER:現在位置}
		ENDIF
	ELSEIF SELECTCOM >= 385 && SELECTCOM <= 389
		TRYCALLFORM KOJO_COM_{NO:TARGET}_{SELECTCOM}_%開催予定祭り名%(TARGET)
		IF FLAG:モード管理 == 2
			呼び出し文字列 = {SELECTCOM}_%開催予定祭り名%
		ENDIF
	ELSEIF SELECTCOM >= 370 && SELECTCOM <= 374
		TRYCALLFORM KOJO_COM_{NO:TARGET}_{SELECTCOM}_{NO:TARGET}(TARGET)
		IF FLAG:モード管理 == 2
			呼び出し文字列 = {SELECTCOM}_{NO:TARGET}
		ENDIF
	ELSEIF SELECTCOM == 404
		;覗きは対象がTARGETじゃないことがあるので別枠で設定
		TRYCALLFORM KOJO_COM_{NO:(RFLAG:コマンド結果受渡し変数２)}_{SELECTCOM}(RFLAG:コマンド結果受渡し変数２)
	ELSEIF SELECTCOM == 414
		;写真撮影は対象がTARGETじゃないことがあるので別枠で設定
		IF RFLAG:コマンド結果受渡し変数３ == 3
			TRYCALLFORM KOJO_COM_{NO:(RFLAG:コマンド結果受渡し変数２)}_{SELECTCOM}(RFLAG:コマンド結果受渡し変数２)
		ELSE
			TRYCALLFORM KOJO_COM_{NO:TARGET}_{SELECTCOM}(TARGET)
		ENDIF
	ELSE
		TRYCALLFORM KOJO_COM_{NO:TARGET}_{SELECTCOM}(TARGET)
		IF FLAG:モード管理 == 2
			呼び出し文字列 = {SELECTCOM}
		ENDIF
	ENDIF
ENDIF

SKIPDISP 0
SIF K < 1
	LOCAL:1 = 1


IF SELECTCOM == 210
	;呼び出される側の口上を呼ぶ
	DRAWLINE
	TRYCALLFORM KOJO_COM_{NO:(RFLAG:コマンド結果受渡し変数)}_{SELECTCOM}_非対象側(RFLAG:コマンド結果受渡し変数)
ENDIF

IF FLAG:モード管理 == 2
	;同時モード時は全員喋らせる
	FOR LOCAL, 0, 同時モード_選択数
		SIF 同時モード_選択キャラ:LOCAL == TARGET
			CONTINUE
		DRAWLINE
		対象キャラ = 同時モード_選択キャラ:LOCAL
		IF CFLAG:対象キャラ:汎用喘ぎ禁止フラグ == -1
			CALL 汎用喘ぎ処理(対象キャラ)
		ELSEIF CFLAG:対象キャラ:汎用喘ぎ禁止フラグ == 1
			;禁止時はなにもしない
		ELSE
			IF TALENT:対象キャラ:性別 == 2
				SIF GETBIT(汎用喘ぎ使用OPTION_男, 0) && GETBIT(汎用喘ぎ使用OPTION_男, 1)
					CALL 汎用喘ぎ処理(対象キャラ)
			ELSE
				SIF GETBIT(汎用喘ぎ使用OPTION, 0) && GETBIT(汎用喘ぎ使用OPTION, 1)
					CALL 汎用喘ぎ処理(対象キャラ)
			ENDIF
		ENDIF
		SIF TCVAR:対象キャラ:食いしばりフラグ
			CONTINUE
		TRYCALLFORM KOJO_COM_{NO:対象キャラ}_%呼び出し文字列%(対象キャラ)
		PRINTL
	NEXT
ENDIF
呼び出し文字列 = 


IF K < 1 && LOCAL:1 == 1
	;通常口上も複数人プレイ口上も無かった場合、非口上メッセージを出す
	;口上なしで汎用喘ぎを使うならここで表示
	対象キャラ = TARGET
	IF CFLAG:対象キャラ:汎用喘ぎ禁止フラグ == 1
		;禁止時はなにもしない
	ELSEIF TFLAG:オートコマンドフラグ == 0
		IF TALENT:対象キャラ:性別 == 2
			SIF GETBIT(汎用喘ぎ使用OPTION_男, 0) && GETBIT(汎用喘ぎ使用OPTION_男, 1) == 0
				CALL 汎用喘ぎ処理(対象キャラ)
		ELSE
			SIF GETBIT(汎用喘ぎ使用OPTION, 0) && GETBIT(汎用喘ぎ使用OPTION, 1) == 0
				CALL 汎用喘ぎ処理(対象キャラ)
		ENDIF
	ENDIF
	SIF TCVAR:対象キャラ:食いしばりフラグ == 0
		CALL TRAIN_MESSAGE_非口上時
ENDIF

IF 自慰ターゲット保存 > -1
	TARGET = 入れ替え保存
ENDIF

;--------------------------------------------------
;@KOJO_MESSAGE_COUNTER関係
;カウンター実行時に出力されます
;--------------------------------------------------
;@KOJO_MESSAGE_COUNTER(ARG)
;VARSET LOCAL
;LOCAL = TARGET
;TARGET = ARG
;IF FLAG:7 <= 0
;	IF FLAG:6 > 0
;		CALL EVENT_COUNTER_MESSAGE
;		TARGET = LOCAL
;	ENDIF
;	RETURN 0
;ENDIF
;
;ボールギャグ
;IF TEQUIP:ARG:20 && FLAG:6 > 0
;	CALL EVENT_COUNTER_MESSAGE
;	TARGET = LOCAL
;ELSE
;	RESULT = 0
;	RESULTS =
;	;口上の存在判定 and RESULTSに文字列代入
;	TRYCALLFORM KOJO_K{NO:ARG}
;	IF !RESULT && FLAG:6 > 0
;		CALL EVENT_COUNTER_MESSAGE
;		TARGET = LOCAL
;		RETURN 0
;	ENDIF
;	TRYCALLFORM KOJO%RESULTS%_MESSAGE_COUNTER_K{NO:TARGET}_{TCVAR:20}
;	TARGET = LOCAL
;ENDIF
;-------------------------------------------------
;@KOJO_ORGASM_射精
;キャラの射精時口上
;-------------------------------------------------
@KOJO_ORGASM_射精
VARSET LOCAL
IF FLAG:汎用文章表示切り替えオプション > 0
	CALL PALAM_MESSAGE_射精
	PRINTL
ENDIF
IF FLAG:口上表示切り替えオプション <= 0
	RETURN 0
ENDIF

;ボールギャグ
; IF TEQUIP:ボールギャグ && SELECTCOM != 106
; 	TRYCALLFORM KOJO_COM_BALLGAG_K{NO:TARGET}
;SELECTCOM
; ELSE
	TRYCALLFORM KOJO_ORGASM_射精_{NO:TARGET}(TARGET)
; ENDIF

;-------------------------------------------------
;@KOJO_MESSAGE_PALAMCNG関係
;パラメータ変動をトリガーにした口上
;パラメータ変動後に口上を発動します
;-------------------------------------------------
@KOJO_ORGASM_絶頂
VARSET LOCAL
IF FLAG:汎用文章表示切り替えオプション > 0
	CALL PALAM_MESSAGE_通常絶頂
	PRINTL
ENDIF
IF FLAG:口上表示切り替えオプション <= 0
	RETURN 0
ENDIF

;ボールギャグ
; IF TEQUIP:ボールギャグ && SELECTCOM != 106
; 	TRYCALLFORM KOJO_COM_BALLGAG_K{NO:TARGET}
;SELECTCOM
; ELSE
	;取得ソースなどで絶頂を分岐させる予定だけど上手い手段が思いつかないので一旦封印
	
	; IF TFLAG:露出コマンドフラグ
	; 	TRYCALLFORM KOJO_ORGASM_露出絶頂_{NO:TARGET}(TARGET)
	; ELSEIF TFLAG:苦痛コマンドフラグ
	; 	TRYCALLFORM KOJO_ORGASM_苦痛絶頂_{NO:TARGET}(TARGET)
	; ELSEIF TFLAG:嗜虐コマンドフラグ
	; 	TRYCALLFORM KOJO_ORGASM_嗜虐絶頂_{NO:TARGET}(TARGET)
	; ELSEIF TFLAG:奉仕コマンドフラグ
	; 	TRYCALLFORM KOJO_ORGASM_奉仕絶頂_{NO:TARGET}(TARGET)
	; ELSEIF TFLAG:道具コマンドフラグ
	; 	TRYCALLFORM KOJO_ORGASM_道具絶頂_{NO:TARGET}(TARGET)
	; ELSE
		TRYCALLFORM KOJO_ORGASM_通常絶頂_{NO:TARGET}(TARGET)
	; ENDIF
; ENDIF
CALL 挿入アニメ表示(TARGET, "_絶頂")

;-------------------------------------------------
;@KOJO_MESSAGE_PALAMCNG関係
;パラメータ変動をトリガーにした口上
;パラメータ変動後に口上を発動します
;-------------------------------------------------
@KOJO_MESSAGE_PALAMCNG_D
IF FLAG:汎用文章表示切り替えオプション > 0
	CALL PALAM_MESSAGE_D
	PRINTL
ENDIF
IF FLAG:口上表示切り替えオプション <= 0
	RETURN 0
ENDIF
;-------------------------------------------------
;@KOJO_MESSAGE_PALAMCNG関係
;触手関連（未実装）
;-------------------------------------------------
@KOJO_MESSAGE_PALAMCNG_E
IF FLAG:7 <= 0
	SIF FLAG:6 > 0
		CALL PALAM_MESSAGE_E
	RETURN 0
ENDIF
RESULT = 0
RESULTS =
;口上の存在判定 and RESULTSに文字列代入
TRYCALLFORM KOJO_K{NO:TARGET}
IF !RESULT && FLAG:6 > 0
	CALL PALAM_MESSAGE_E
	RETURN 0
ENDIF
;ボールギャグ
LOCALS = 
; IF TEQUIP:20 && SELECTCOM != 106
; 	LOCALS = BALLGAG_
; ENDIF
TRYCALLFORM KOJO%RESULTS%_MESSAGE_PALAMCNG_E_K%LOCALS%{NO:TARGET}

;-------------------------------------------------
;@KOJO_MESSAGE_MARKCNG関係
;刻印変動をトリガーにした口上
;刻印変動後に口上を発動します
;-------------------------------------------------
@KOJO_MESSAGE_MARKCNG
IF FLAG:7 <= 0
	SIF FLAG:6 > 0
		CALL MARK_MESSAGE
	RETURN 0
ENDIF
RESULT = 0
RESULTS =
;口上の存在判定 and RESULTSに文字列代入
TRYCALLFORM KOJO_K{NO:TARGET}
IF !RESULT && FLAG:6 > 0
	CALL MARK_MESSAGE
	RETURN 0
ENDIF
;ボールギャグ
LOCALS = 
; IF TEQUIP:20 && SELECTCOM != 106
; 	LOCALS = BALLGAG_
; ENDIF
TRYCALLFORM KOJO%RESULTS%_MESSAGE_MARKCNG_%LOCALS%K{NO:TARGET}

;-------------------------------------------------
;@KOJO_MESSAGE_ENDING関係
;イベント時の口上、イベント開始時に出力します
;-------------------------------------------------
@KOJO_MESSAGE_ENDING
TRYCALLFORM KOJO_MESSAGE_ENDING_K{NO:TARGET}

;-------------------------------------------------
;@KOJO_EVENT
;イベント時の口上、イベント開始時に出力します
;-------------------------------------------------
@KOJO_EVENT(ARG,ARG:1,ARG:2,ARG:3)
;ARG イベント番号(0=屋敷で遭遇した
;ARG:1 口上主
;ARG:2～口上に渡す引数
LOCAL = TARGET
TARGET = ARG:1
IF FLAG:7 <= 0
	TRYCALLFORM KOJO_EVENT_{NO:ARG}(ARG:2,ARG:3)
	TARGET = LOCAL
	RETURN 0
ENDIF
RESULT = 0
RESULTS =
TRYCALLFORM KOJO_K{NO:TARGET}
IF !RESULT
	TRYCALLFORM KOJO_EVENT_{NO:ARG}(ARG:2,ARG:3)
	TARGET = LOCAL
	RETURN 0
ENDIF
TRYCALLFORM KOJO%RESULTS%_EVENT_K{NO:TARGET}_{NO:ARG}(ARG:2,ARG:3)
TARGET = LOCAL

