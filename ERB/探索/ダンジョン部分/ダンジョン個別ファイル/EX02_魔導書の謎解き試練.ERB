

@ダンジョン初期処理_魔導書の謎解き試練
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

ダンジョンサブタイトル = THE BOOK OF RIDDLES
ダンジョンマス画像URL_伏せ状態 = 壁_遺跡
ダンジョン現在位置:0 = 0
ダンジョン現在位置:1 = 4
ダンジョン背景画像 = 背景_遺跡

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：マスをオープンするか（ビット１をONにしないと無意味）　ビット3：入れないがオープンする場合に使用
;ビット4以降：自由枠。主に宝箱の開閉やイベント達成フラグなどに使用
IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}", 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{深度}:{分岐}")
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_%ダンジョン名%_{深度}_{分岐}")
			LOCAL = 1
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:深度:分岐", 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_魔導書の謎解き試練

詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "リゾートに招待した異世界の客、フリーレン御一行様が魔導書に閉じ込められてしまった。<br>"
詳細文文字列受け渡し変数 += "あなたは星晶獣eraとともにフリーレンたちを迎えに行くため、<br>"
詳細文文字列受け渡し変数 += "謎解きの試練を持つ魔導書の中に赴く。<br>"
詳細文文字列受け渡し変数 += "<br>"
詳細文文字列受け渡し変数 += "ダンジョン出典：葬送のフリーレン<br>"

;推奨レベルを返す
RETURN 1

;@敵討伐後処理_ダンジョン固有_魔導書の謎解き試練(討伐エネミー数)
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;今回アイテムドロップはないので記述なし

;---------------------------------------------------------------------
;マップ構造
;---------------------------------------------------------------------
;イベントミニマップなのでほぼ一本道
;---------------------------------------------------------------------

@ダンジョンマス情報_魔導書の謎解き試練_0_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 0
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "1_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 魔導書を開き、中に入る。
			WSTR:(K++) = 一瞬で周囲の風景が切り替わり、石造りの遺跡のような建物の内部に移動したようだ。
			WSTR:(K++) = 隣には星晶獣eraの姿がある。無事にはぐれずに突入出来たようだ。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ふぅん……古めかしい演出だが、術式は割と新しい……。
			WSTR:(K++) = 　作られたのはせいぜい２，３年前くらいかな」
			CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
			CALL 口上変数初期化
			WSTR:(K++) = eraはうきうきで周囲を調べている。楽しそうでなによりだ。
			WSTR:(K++) = 本の中は薄暗いが、少し離れた場所に人影が見える。
			WSTR:(K++) = 恐らくは先に本の中に入っていたお客様たちだろう。先に進み、合流しよう。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 少し離れた場所に人影が見える。
			KSTR:(K++) = 恐らくは先に本の中に入っていたお客様たちだろう。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_1_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 1
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = フリーレン、フェルン、シュタルクと合流した。
			CALL 再視聴確認(再戦闘_なし)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]フリーレン"),100,,,1,1)
			立ち絵_フリーレン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
			立ち絵_フェルン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[戦士]シュタルク"),102,,,1,1)
			立ち絵_シュタルク = %立ち絵リソース記録%
			WSTR:(K++) = eraを連れ、近くに見えていた人影の方に近づく。
			WSTR:(K++) = 一人は白髪で髪を２つにくくった華奢な少女。
			WSTR:(K++) = 一人は紫がかった黒髪を伸ばし、黒いローブを纏った若い女性。
			WSTR:(K++) = 最後に大きな斧を背負った赤髪の若い青年。
			WSTR:(K++) = %CALLNAME:PLAYER%がリゾートに招待した「フリーレン」「フェルン」「シュタルク」で間違いないだろう。
			WSTR:(K++) = %CALLNAME:PLAYER%は三人に声を掛け、これまでの経緯を説明する。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「なるほどね、本の中の空間か。
			WSTR:(K++) = 　こちらの世界には面白い魔法があるんだね」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「私達が足止めされていた理由もわかりました。
			WSTR:(K++) = 　シュタルク様が攻撃をした罰則だったんですね」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ごめんって……魔物かと思ったんだよぉ」
			CALL メッセージ欄表示用関数(立ち絵_シュタルク,"シュタルク",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 三人のすぐそばには、豪奢なローブを纏った骸骨の石像がある。
			WSTR:(K++) = 石像は何やら文章が刻まれた石板を持っており、魔力に反応して文字を書き込むことが出来るようだ。
			WSTR:(K++) = つまりはこれが『謎解き』の舞台装置であり、石像への攻撃などは反則ということだろう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「一度の攻撃で一時間の解答不能。
			WSTR:(K++) = 　何回も攻撃した時は他の罰則が発動する可能性があるね。
			WSTR:(K++) = 　真っ当に謎解きをするのが一番かな」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = フリーレンの立ち振舞は熟練の魔法使いのそれだ。
			WSTR:(K++) = 試練とはいえ、謎解き程度ならすぐに解いてしまうだろう。
			WSTR:(K++) = 星晶獣eraも自信がありそうだし、これなら苦労せずに脱出することが出来そうだ。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「おいおい、何を言ってるんだ。
			WSTR:(K++) = 　お前が解くんだよ、我が契約者」
			CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
			CALL 口上変数初期化
			WSTR:(K++) = なんか言い出したぞこいつ。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「私やそこの魔法使いがすぐ解いて終わりでは面白くないだろう。
			WSTR:(K++) = 　こういうのは人が悩んでいる姿を見るのが楽しいんだ」
			CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「面白いかどうかはわからないけど、そうだね。こういう修行もたまにはいいかな。
			WSTR:(K++) = 　フェルン、解いてみようか」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = フリーレンに促されたフェルンは、素直に謎解きに挑戦し始めた。
			WSTR:(K++) = eraが期待に満ちた目でこちらを見てくる。
			WSTR:(K++) = しょうがないので、%CALLNAME:PLAYER%も謎解きにチャレンジしよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_4_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 4
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 誰に話を聞いてみようか？
		KSTR:(K++) = BUTTON_[シュタルクと話す]_（ちょっとヒント）
		KSTR:(K++) = BUTTON_[フェルンと話す]_（大きなヒント）
		KSTR:(K++) = BUTTON_[フリーレンと話す]_（ほぼ答え）
		KSTR:(K++) = BUTTON_[やっぱりやめる]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[シュタルクと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[戦士]シュタルク"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = 赤毛の戦士に話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「え、俺？　俺こういうの苦手なんだよな……。
				WSTR:(K++) = 　でも、あいこにはなってないんだろ？
				WSTR:(K++) = 　なんかこう……上手いこと組み合わせれば、ピシッとハマるんじゃないか？」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"シュタルク",,0)
				CALL 口上変数初期化
				WSTR:(K++) = シュタルクはうんうんと悩んでいる。
				WSTR:(K++) = 確かにあいこがないという部分は重要な情報に思える。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[フェルンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = 黒髪の魔法使いに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「そうですね……。
				WSTR:(K++) = 　フェザー様のチョキが一つだけ飛び抜けているところが気になります。
				WSTR:(K++) = 　ここから考えていくつもりです」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = フェルンは地面に文字を書いて考えている。
				WSTR:(K++) = フェザーのチョキは確かに特徴的だ。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[フリーレンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]フリーレン"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = 白髪の魔法使いに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「私たちの世界にも古くからある論理系の謎掛けだね。
				WSTR:(K++) = 　こういうのはね、状況を限定して考えてみるんだ。
				WSTR:(K++) = 　例えば、フェザーがチョキを出した時ランドルの手は……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「おっと、それ以上は答えを教えるようなものだ。そこで止まりたまえ、魔法使い」
				CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
				CALL 口上変数初期化
				WSTR:(K++) = eraに口を塞がれたフリーレンはむむむと呻いている。
				WSTR:(K++) = 状況を限定する、か。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[やっぱりやめる]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_4_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 4
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "6_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 石像が持っている謎を見てみよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = ここに、じゃんけんを１０回行う二人の男、フェザーとランドルがいる。
			KSTR:(K++) = フェザーはグーを１回、チョキを７回、パーを２回出した。
			KSTR:(K++) = ランドルはグーを３回、チョキを３回、パーを４回出した。
			KSTR:(K++) = あいこには一度もならなかったとすると、勝った数が多いのはどちらだ？
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = なかなか難しそうな謎だ。
			WSTR:(K++) = 他の誰かと一緒に考えて、ヒントになる考えを貰ってもいいかもしれない。
			WSTR:(K++) = あるいは、どうしてもわからないのならギブアップしてeraに答えてもらう手もある。
			WSTR:(K++) = ヒントを聞く場合は上のマスへ。解答する、あるいはギブアップするなら右のマスへ進もう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = ここに、じゃんけんを１０回行う二人の男、フェザーとランドルがいる。
			KSTR:(K++) = フェザーはグーを１回、チョキを７回、パーを２回出した。
			KSTR:(K++) = ランドルはグーを３回、チョキを３回、パーを４回出した。
			KSTR:(K++) = あいこには一度もならなかったとすると、勝った数が多いのはどちらだ？
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_6_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 6
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "7_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 第一の謎にチャレンジした。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = さて、なんと解答しようか。
			KSTR:(K++) = BUTTON_[フェザーの勝ちが多い]
			KSTR:(K++) = BUTTON_[ランドルの勝ちが多い]
			KSTR:(K++) = BUTTON_[どっちも同じ]
			KSTR:(K++) = BUTTON_[ギブアップしてeraに答えてもらう]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[フェザーの勝ちが多い]", "[ランドルの勝ちが多い]"
					WSTR:(K++) = 「不正解！！」
					CALL メッセージ欄表示用関数(,"石像の声",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 石像から声が響くと同時に、%CALLNAME:PLAYER%の上から大量の水が降ってきた。
					WSTR:(K++) = 怪我をするような勢いではなかったが、びしょ濡れになってしまっている……。
					WSTR:(K++) = 不正解のペナルティということだろう。もう一度、考え直してみよう。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
						CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
						ダンジョン現在位置:0 = 4
						ダンジョン現在位置:1 = 4
					ENDIF
					RETURN 0
				CASE "[どっちも同じ]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「汝の叡智を認めよう……」
					CALL メッセージ欄表示用関数(,"石像の声",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 石像から声が響くと同時に、次の部屋へ進む扉が開いた。
					WSTR:(K++) = 無事に正解出来たらしい。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「フェザー様もランドル様も５勝５敗。つまり同じが正解です。
					WSTR:(K++) = 　合っていたようで安心しました」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
					CALL 口上変数初期化
					WSTR:(K++) = フェルンの方も正解を導き出せていたようだ。
					WSTR:(K++) = 大手を振って次の部屋に進むとしよう。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASE "[ギブアップしてeraに答えてもらう]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「しょうがないな、我が契約者は。
					WSTR:(K++) = 　では星晶獣たる私が解答と解説をしてやろう」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = お願いしますera様。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「まず着目すべき点は「あいこにはならなかった」と「一番多いフェザーのチョキ」だ。
					WSTR:(K++) = 　つまり、ここから「フェザーがチョキの時　＝　ランドルがグー　＋　ランドルがパー」という状況が導き出せる。
					WSTR:(K++) = 　この時点でフェザーは４勝３敗、ランドルは３勝４敗ということが確定するわけだ」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「あとは残りの、「ランドルがチョキ　＝　フェザーがグー　＋　フェザーがパー」の時について考えてやればいい。
					WSTR:(K++) = 　合計すると、二人とも５勝５敗になる。という寸法だ」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = eraがドヤ顔で解説しながら答えを入力すると、次の部屋へ進む扉が開いた。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「合っていたようで安心しました」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
					CALL 口上変数初期化
					WSTR:(K++) = フェルンの方は正解を導き出せていたようだ。
					WSTR:(K++) = %CALLNAME:PLAYER%はギブアップしてしまったが、気を取り直して次の部屋に進もう。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_7_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 7
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		IF 初来訪マス判定用フラグ
			;移動直後はマスイベント発動しないので、移動先のルート開放をここで行う
			CALL 接続ルート全開放処理(8, 4)
		ENDIF
		ダンジョン現在位置:0 = 8
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_8_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 8
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "11_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 7
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_11_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 11
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 誰に話を聞いてみようか？
		KSTR:(K++) = BUTTON_[シュタルクと話す]_（ちょっとヒント）
		KSTR:(K++) = BUTTON_[フェルンと話す]_（大きなヒント）
		KSTR:(K++) = BUTTON_[フリーレンと話す]_（ほぼ答え）
		KSTR:(K++) = BUTTON_[やっぱりやめる]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[シュタルクと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[戦士]シュタルク"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = シュタルクに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「ちょっと待ってくれ。ややこしくて……。
				WSTR:(K++) = 　えーと、一番多くて１０人で。あれ、自分と恋人とは握手してないのか。じゃあえーと８人で……」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"シュタルク",,0)
				CALL 口上変数初期化
				WSTR:(K++) = シュタルクはうんうんと悩んでいる。
				WSTR:(K++) = ただ「握手をした人数の最大数は８人」という点は重要なヒントになりそうだ。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[フェルンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = フェルンに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「全員答えた数が違う、ということは……
				WSTR:(K++) = 　９人の質問の答えはそれぞれ０，１，２，３，４，５，６，７，８人だと思います。
				WSTR:(K++) = 　ただ、これをどう組み合わせていくかが問題で……」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = フェルンは地面に文字を書いて考えている。
				WSTR:(K++) = 質問の答えは０人から８人で間違いないだろう。
				WSTR:(K++) = ここから組み合わせが求められないかどうか、もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[フリーレンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]フリーレン"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = フリーレンに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「少し複雑だけど、解法としては同じことの繰り返しだね。
				WSTR:(K++) = 　それぞれを個別に考えるのではなく、恋人１組ごとに考えてみよう。
				WSTR:(K++) = 　８人と答えた人の恋人は、何人と答えた人になるか。それは……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「おっと、それ以上は答えを教えるようなものだ。そこで止まりたまえ、魔法使い」
				CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
				CALL 口上変数初期化
				WSTR:(K++) = eraに口を塞がれたフリーレンはむむむと呻いている。
				WSTR:(K++) = 恋人一組ごとに考える、か。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[やっぱりやめる]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_11_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 11
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "11_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "13_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 次の部屋に来た。この部屋でも同じ石像が、謎の書かれた石板を持っているようだ。
			WSTR:(K++) = 石像が持っている謎を見てみよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = ここに、恋人同士であるロミオとジュリエットがいる。
			KSTR:(K++) = ロミオとジュリエットは、４組の恋人たち（合計８人）を招待してパーティーを開いた。
			KSTR:(K++) = パーティーの中で、参加した１０名は「初対面の相手」とだけ握手を行った。
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			KSTR:(K++) = パーティが終わった後、ロミオは自分以外のパーティー参加者９人に「何人と握手をしたか」と聞いた。
			KSTR:(K++) = すると、９人全員が異なる答えを返した。
			KSTR:(K++) = では、ジュリエットは何人と握手をしたのだろうか？
			KSTR:(K++) = 補足するが、「このパーティーで自分の恋人と初めて会った」という人はいない。 
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = 結構難しそうな謎だ。
			WSTR:(K++) = 他の誰かと一緒に考えて、ヒントになる考えを貰ってもいいかもしれない。
			WSTR:(K++) = あるいは、どうしてもわからないのならギブアップしてeraに答えてもらう手もある。
			WSTR:(K++) = ヒントを聞く場合は上のマスへ。解答する、あるいはギブアップするなら右のマスへ進もう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = ここに、恋人同士であるロミオとジュリエットがいる。
			KSTR:(K++) = ロミオとジュリエットは、４組の恋人たち（合計８人）を招待してパーティーを開いた。
			KSTR:(K++) = パーティーの中で、参加した１０名は「初対面の相手」とだけ握手を行った。
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			KSTR:(K++) = パーティが終わった後、ロミオは自分以外のパーティー参加者９人に「何人と握手をしたか」と聞いた。
			KSTR:(K++) = すると、９人全員が異なる答えを返した。
			KSTR:(K++) = では、ジュリエットは何人と握手をしたのだろうか？
			KSTR:(K++) = 補足するが、「このパーティーで自分の恋人と初めて会った」という人はいない。 
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_13_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 13
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 第二の謎にチャレンジした。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = さて、なんと解答しようか。
			KSTR:(K++) = BUTTON_[数字を入力する]
			KSTR:(K++) = BUTTON_[ギブアップしてeraに答えてもらう]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[数字を入力する]"
					DRAWLINE
					PRINTL 任意の数値を入力してください（半角数字）
					DRAWLINE
					INPUT
					SELECTCASE RESULT
						CASE 4
							CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
							立ち絵_フェルン = %立ち絵リソース記録%
							WSTR:(K++) = 「汝の叡智を認めよう……」
							CALL メッセージ欄表示用関数(,"石像の声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像から声が響くと同時に、次の部屋へ進む扉が開いた。
							WSTR:(K++) = 無事に正解出来たらしい。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							WSTR:(K++) = 「ロミオ様もジュリエット様も、どちらも４人と握手をしていますね。
							WSTR:(K++) = 　なんとか正解出来ました」
							CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
							CALL 口上変数初期化
							WSTR:(K++) = フェルンの方も正解を導き出せていたようだ。
							WSTR:(K++) = 大手を振って次の部屋に進むとしよう。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
						CASEELSE
							WSTR:(K++) = 「不正解！！」
							CALL メッセージ欄表示用関数(,"石像の声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像から声が響くと同時に、%CALLNAME:PLAYER%の上から大量の水が降ってきた。
							WSTR:(K++) = 怪我をするような勢いではなかったが、びしょ濡れになってしまっている……。
							WSTR:(K++) = 不正解のペナルティということだろう。もう一度、考え直してみよう。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
								CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
								ダンジョン現在位置:0 = 11
								ダンジョン現在位置:1 = 4
							ENDIF
							RETURN 0
					ENDSELECT
				CASE "[ギブアップしてeraに答えてもらう]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「しょうがないな、我が契約者は。
					WSTR:(K++) = 　では星晶獣たる私が解答と解説をしてやろう」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = お願いしますera様。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「まず着目すべき点は「全員握手をした人数が異なる」「恋人と初対面の者はいない」点だ。
					WSTR:(K++) = 　つまり、ここから「それぞれの答えは０人～８人」という状況が導き出せる。
					WSTR:(K++) = 　では次に、「８人と答えた者の恋人」について考えてみよう」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「８人と答えた者が存在する以上、「８人と答えた者とその恋人以外は、必ず１回は握手をしている」ことになる。
					WSTR:(K++) = 　つまり、消去法により「８人と答えた者の恋人は、０人と答えた者である」ことが確定するわけだ」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 　あとは繰り返しだ。７人と答えた者は、「０人と答えた者・自分・自分の恋人以外と全て握手をしている」ので
					WSTR:(K++) = 　７人と答えた者とその恋人以外は、必ず２回は握手をしている。つまり「７人と答えた者の恋人は、１人と答えた者である」」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「組み合わせとしては８－０、７－１、６－２、５－３となり……余った最後の組み合わせは４－４。
					WSTR:(K++) = 　つまりジュリエットが握手した人数は４人だ。
					WSTR:(K++) = 　ロミオだけは質問に答えていないため、ジュリエットと人数が同じでも矛盾しない。
					WSTR:(K++) = 　さて、お前はどこまで理解出来たかな？」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = eraがドヤ顔で解説しながら答えを入力すると、次の部屋へ進む扉が開いた。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「なんとか正解出来ました」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
					CALL 口上変数初期化
					WSTR:(K++) = フェルンの方は正解を導き出せていたようだ。
					WSTR:(K++) = %CALLNAME:PLAYER%はギブアップしてしまったが、気を取り直して次の部屋に進もう。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_15_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		IF 初来訪マス判定用フラグ
			;移動直後はマスイベント発動しないので、移動先のルート開放をここで行う
			CALL 接続ルート全開放処理(16, 4)
		ENDIF
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_16_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_19_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 19
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 誰に話を聞いてみようか？
		KSTR:(K++) = BUTTON_[フェルンと話す]_（ちょっとヒント）
		KSTR:(K++) = BUTTON_[フリーレンと話す]_（大きなヒント）
		KSTR:(K++) = BUTTON_[シュタルクと話す]_（ほぼ答え）
		KSTR:(K++) = BUTTON_[やっぱりやめる]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[フェルンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = フェルンに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「ティアマト様２人とユグドラシル様３人がコロッサス様と等しいから……
				WSTR:(K++) = 　ティアマト様は……これ、体重が確定しないのでは……」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = フェルンは地面に文字を書いて考えている。
				WSTR:(K++) = 確かに、この条件ではそれぞれの体重は確定しない。
				WSTR:(K++) = もしかしたら、星晶獣の体重と答えは関係ないのではないだろうか？　もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[フリーレンと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]フリーレン"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = フリーレンに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「「私」が何を指しているかが重要じゃないかな。
				WSTR:(K++) = 　こういう謎掛けも懐かしいね。
				WSTR:(K++) = 　昔、ヒンメルたちと旅をしてた時も謎掛けダンジョンに挑戦したことがあってね……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 思い出話が始まってしまった。面白そうな話だが、長くなりそうだ。
				WSTR:(K++) = 「私」が何を指しているかを考える、か。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[シュタルクと話す]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[戦士]シュタルク"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = シュタルクに話しかけてみよう。この謎、どう思う？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「えぇ……これダジャレじゃん……
				WSTR:(K++) = 　だって像の見た目が」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"シュタルク",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「おっと、それ以上は答えを教えるようなものだ。そこで止まりたまえ」
				CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
				CALL 口上変数初期化
				WSTR:(K++) = シュタルクはeraに口を塞がれてもがーと呻いている。
				WSTR:(K++) = 像の見た目、か。問題を出す像はどういう見た目をしていただろうか？
				WSTR:(K++) = 前のマスをもう一度見てくるのもいいかもしれない。もう一度考えてみよう。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[やっぱりやめる]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_19_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 19
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 次の部屋に来た。この部屋でも同じ石像が、謎の書かれた石板を持っているようだ。
			WSTR:(K++) = また、石板にはこれが最後の謎だと書かれている。
			WSTR:(K++) = 石像が持っている謎を見てみよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = ここに、体重が１００トンの星晶獣であるコロッサスがいる。
			KSTR:(K++) = ティアマトの体重はコロッサスの半分よりも軽く、ユグドラシルの体重はティアマトよりも軽い。
			KSTR:(K++) = ティアマト２人分の体重とユグドラシル３人分の体重を足したものと、コロッサスの体重は等しい。
			KSTR:(K++) = さて、では私は何トンだ？ 
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = これは……？　一風変わった謎のようだ。
			WSTR:(K++) = 他の誰かと一緒に考えて、ヒントになる考えを貰ってもいいかもしれない。
			WSTR:(K++) = あるいは、どうしてもわからないのならギブアップしてeraに答えてもらう手もある。
			WSTR:(K++) = ヒントを聞く場合は上のマスへ。解答する、あるいはギブアップするなら右のマスへ進もう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = ここに、体重が１００トンの星晶獣であるコロッサスがいる。
			KSTR:(K++) = ティアマトの体重はコロッサスの半分よりも軽く、ユグドラシルの体重はティアマトよりも軽い。
			KSTR:(K++) = ティアマト２人分の体重とユグドラシル３人分の体重を足したものと、コロッサスの体重は等しい。
			KSTR:(K++) = さて、では私は何トンだ？ 
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_21_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 21
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "23_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 第三の謎にチャレンジした。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = さて、なんと解答しようか。
			KSTR:(K++) = BUTTON_[答えを入力する]
			KSTR:(K++) = BUTTON_[ギブアップしてeraに答えてもらう]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[答えを入力する]"
					DRAWLINE
					PRINTL 任意の答えを入力してください（全角）
					DRAWLINE
					INPUTS
					SELECTCASE RESULTS
						CASE "スケルトン", "スケル"
							CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
							立ち絵_フェルン = %立ち絵リソース記録%
							WSTR:(K++) = 「汝の叡智を認めよう……」
							CALL メッセージ欄表示用関数(,"石像の声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像から声が響くと同時に、次の部屋へ進む扉が開いた。
							WSTR:(K++) = 無事に正解出来たらしい。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							WSTR:(K++) = 「……体重、関係ないじゃないですか」
							CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
							CALL 口上変数初期化
							WSTR:(K++) = フェルンの方はわからなかったようで、むすーと頬を膨らませている。
							WSTR:(K++) = これで謎は全て終わりのようだ。
							WSTR:(K++) = 先に進んで、本の中から脱出しよう。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
						CASEELSE
							WSTR:(K++) = 「不正解！！」
							CALL メッセージ欄表示用関数(,"石像の声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像から声が響くと同時に、%CALLNAME:PLAYER%の上から大量の水が降ってきた。
							WSTR:(K++) = 怪我をするような勢いではなかったが、びしょ濡れになってしまっている……。
							WSTR:(K++) = 不正解のペナルティということだろう。もう一度、考え直してみよう。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
								CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
								ダンジョン現在位置:0 = 11
								ダンジョン現在位置:1 = 4
							ENDIF
							RETURN 0
					ENDSELECT
				CASE "[ギブアップしてeraに答えてもらう]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「しょうがないな、我が契約者は。
					WSTR:(K++) = 　では星晶獣たる私が解答と解説をしてやろう」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = お願いしますera様。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「まず着目すべき点は「答えるべきは「私」であり、星晶獣は関係ない」点だ。
					WSTR:(K++) = 　つまり、体重１００トンだの何だのは一切関係ない。
					WSTR:(K++) = 　最初の２問が論理を問う謎掛けであったことを踏まえた、一種のひっかけ問題だな」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「では、「私」とは何なのか。それは問題を出している石像そのもののことだ。
					WSTR:(K++) = 　石像の見た目は覚えているか？　そう、「豪奢なローブを纏った骸骨の石像」だ。
					WSTR:(K++) = 　骸骨で、「◯◯トン」といえば……「スケルトン」を思いつくのは難しくないだろう」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「ま、ダジャレみたいなものだ。
					WSTR:(K++) = 　ピンと来るかどうか、運要素も大きい。答えられなくても落ち込むことはないさ」
					CALL メッセージ欄表示用関数("顔エラ","星晶獣era",,0)
					CALL 口上変数初期化
					WSTR:(K++) = eraがドヤ顔で解説しながら答えを入力すると、最後の扉が開いた。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「……体重、関係ないじゃないですか」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
					CALL 口上変数初期化
					WSTR:(K++) = フェルンの方もわからなかったようで、むすーと頬を膨らませている。
					WSTR:(K++) = %CALLNAME:PLAYER%はギブアップしてしまったが、これで謎は終わりのようだ。
					WSTR:(K++) = 先に進んで、本の中から脱出しよう。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_23_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 23
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 魔法を手に入れ、本の中から脱出した。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]フリーレン"),100,,,1,1)
			立ち絵_フリーレン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[フリーレンの弟子]フェルン"),101,,,1,1)
			立ち絵_フェルン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[戦士]シュタルク"),102,,,1,1)
			立ち絵_シュタルク = %立ち絵リソース記録%
			WSTR:(K++) = 謎を解いて進んだ最奥には、一冊の魔導書が浮かんでいた。
			WSTR:(K++) = 魔導書の中で魔導書というのも妙な話だが、ともあれこれで魔法を習得出来るらしい。
			WSTR:(K++) = どういう魔法が収められているのだろうか。フリーレンが魔導書を手に取り、ぺらぺらとめくる。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「これは……「本を開く時、最後に読んだページを一回で開く魔法」だね」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 栞を使えばいいのでは。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「フリーレン様は変わった魔法を集めるのが好きなんです」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 本人が満足ならいいんだが……。
			WSTR:(K++) = ともあれ、トラブルもあったがこれで脱出出来るだろう。
			WSTR:(K++) = リゾートでゆっくりしていって欲しい、と三人に歓迎の意を示す。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「久々に街で眠れるの、楽しみだな」
			CALL メッセージ欄表示用関数(立ち絵_シュタルク,"シュタルク",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「違う世界なんて、流石の私も初めてだからね。
			WSTR:(K++) = 　異世界の魔導書をできるだけ買っておきたいな」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"フリーレン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あんまり無駄使いしないでくださいね。路銀も心許ないんですから」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"フェルン",,0)
			CALL 口上変数初期化
			WSTR:(K++) = わいわいと騒ぐ三人と一緒に、魔導書から脱出する。
			WSTR:(K++) = 星晶獣eraも謎解き遊びに満足したようで、機嫌良さげな顔をしている。
			WSTR:(K++) = なかなか大変なダンジョンだったが、誰も怪我をしてないし良しとしておこうか。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [葬送]フリーレンがリゾートを訪れるようになった！
			WSTR:(K++) = [フリーレンの弟子]フェルンがリゾートを訪れるようになった！
			WSTR:(K++) = [戦士]シュタルクがリゾートを訪れるようになった！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CFLAG:(キャラ検索("[葬送]フリーレン")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[フリーレンの弟子]フェルン")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[戦士]シュタルク")):招待不可フラグ = 0

			IF 滞在キャラ上限 - 滞在キャラ数 - 集客人数 - FLAG:滞在キャラ枠先確保分 > 2
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[葬送]フリーレン")
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[フリーレンの弟子]フェルン")
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[戦士]シュタルク")
				FLAG:滞在キャラ枠先確保分 += 3
			ENDIF

			ダンジョン終了状況 = 踏破達成
			ダンジョンクリアフラグ_魔導書の謎解き試練 = 1
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




