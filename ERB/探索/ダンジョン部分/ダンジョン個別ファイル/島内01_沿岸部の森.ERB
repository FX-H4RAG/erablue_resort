

@ダンジョン初期処理_沿岸部の森
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

ダンジョンマス画像URL_伏せ状態 = 壁_森
ダンジョン現在位置:0 = 0
ダンジョン現在位置:1 = 0

;スタート地点は必ず存在し、同深度に分岐無し
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：そこから通路を伸ばすか　ビット3：入れないが表示する場合に使用
IF ダンジョン構造配列_沿岸部の森:0:0 == 0
	ダンジョン構造配列_沿岸部の森:0:0 = 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF ダンジョン構造配列_沿岸部の森:深度:分岐
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_沿岸部の森_{深度}_{分岐}")
			LOCAL = 1
			ダンジョン構造配列_沿岸部の森:深度:分岐 = 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョンマス情報_沿岸部の森_0_0(ARGS)
#DIMS マス番号
マス番号 = 0_0

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
	CASE "接続先"
		;分岐０と分岐３に繋がる
		CALL ダンジョン分岐線描画(マス番号, "1_0")
	CASE "マスイベント"
		CALL 口上変数初期化
		IF GETBIT(ダンジョン構造配列_沿岸部の森:0:0, 2)
		ELSE
			;最初に訪れた時
			WSTR:(K++) = %CALLNAME:PLAYER%は初めてダンジョンへと足を踏み入れた。
			KSTR:(K++) = %CALLNAME:PLAYER%は、星晶獣eraが言っていた注意点を思い出す……
			CALL メッセージ欄表示用関数()
			SETBIT ダンジョン構造配列_沿岸部の森:0:0, 2
			SETBIT ダンジョン構造配列_沿岸部の森:1:0, 1
			CALL 口上変数初期化
			WSTR:(K++) = 「いいかね。左上に_IMAGE_自機アイコン_が見えるだろう？」
			WSTR:(K++) = 「それがお前の現在位置だ」
			KSTR:(K++) = 「違うマスをクリックすることで移動出来る。試しに隣のマスに移動してみたまえ」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era",,0)
		ENDIF
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_沿岸部の森_1_0(ARGS)
#DIMS マス番号
マス番号 = 1_0

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		;分岐０と分岐３に繋がる
		CALL ダンジョン分岐線描画(マス番号, "2_0")
	CASE "マスイベント"
		CALL 口上変数初期化
		IF GETBIT(ダンジョン構造配列_沿岸部の森:1:0, 2)
			KSTR:(K++) = 敵を探しますか？
			KSTR:(K++) = BUTTON_[はい]
			KSTR:(K++) = BUTTON_[いいえ]
			CALL メッセージ欄表示用関数(,,,0)
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[はい]"
					敵BATTLE_STATE_STR:0:エネミー名 = ゴブリン
					敵BATTLE_STATE_STR:1:エネミー名 = ゴブリン
					CALL 雑魚敵遭遇汎用処理
				CASE "[いいえ]"
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					GOTO LOOP_MESSAGE
			ENDSELECT
		ELSE
			;最初に訪れた時
			WSTR:(K++) = 「訪れたことのないマスは、そこに何があるのか最初はわからない」
			WSTR:(K++) = 「敵がいるのか、宝箱があるのか……」
			KSTR:(K++) = 「ほら、言ったそばから敵が現れたぞ」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era")
			SETBIT ダンジョン構造配列_沿岸部の森:1:0, 2
			
			敵BATTLE_STATE_STR:0:エネミー名 = ゴブリン
			敵BATTLE_STATE_STR:1:エネミー名 = ゴブリン
			CALL 雑魚敵遭遇汎用処理

			CALL 口上変数初期化
			WSTR:(K++) = 「雑魚敵がいるマスは、再び訪れることで敵を探すことが出来る」
			WSTR:(K++) = 「仲間の練度を高め、ルピを集めるには最適だ」
			KSTR:(K++) = 「倒すことが出来るのなら、だがね」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era")
			SETBIT ダンジョン構造配列_沿岸部の森:2:0, 1
			CALL 口上変数初期化
		ENDIF
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_沿岸部の森_2_0(ARGS)
#DIMS マス番号
マス番号 = 2_0

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
		IF GETBIT(ダンジョン構造配列_沿岸部の森:3:0, 1)
			ダンジョンマス画像URL_重ね表示 = 宝箱アイコン_木箱_開
		ELSE
			ダンジョンマス画像URL_重ね表示 = 宝箱アイコン_木箱
		ENDIF
	CASE "接続先"
		CALL ダンジョン分岐線描画(マス番号, "3_0")
	CASE "マスイベント"
		CALL 口上変数初期化
		IF GETBIT(ダンジョン構造配列_沿岸部の森:2:0, 2)
			KSTR:(K++) = 箱はからっぽだ。
			CALL メッセージ欄表示用関数(,,,0)
		ELSE
			;最初に訪れた時
			SETBIT ダンジョン構造配列_沿岸部の森:2:0, 2
			WSTR:(K++) = 「今度は宝箱だね。中には何かアイテムが入っているはずだ」
			WSTR:(K++) = 「もっと難しいダンジョンなら、罠が仕掛けられていることもあるかもしれない」
			KSTR:(K++) = 「このダンジョンでは無縁の事柄だがね。遠慮なく開けてみたまえ」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era")
			CALL 口上変数初期化
			SETBIT ダンジョン構造配列_沿岸部の森:3:0, 1
			WSTR:(K++) = %CALLNAME:PLAYER%は宝箱を開けた。
			KSTR:(K++) = 中には薬草が１０個入っていた！！
			CALL メッセージ欄表示用関数()

			CALL 口上変数初期化
			CALL アイテム増減汎用処理("薬草", 10)
		ENDIF
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_沿岸部の森_3_0(ARGS)
#DIMS マス番号
マス番号 = 3_0

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
		ダンジョンマス画像URL_重ね表示 = えっちハート
	CASE "接続先"
		;分岐０と分岐３に繋がる
		CALL ダンジョン分岐線描画(マス番号, "7_0")
	CASE "マスイベント"
		CALL 口上変数初期化
		IF GETBIT(ダンジョン構造配列_沿岸部の森:3:0, 2)
			CALL ダンジョンハプニング_乳タッチ()
			CALL 口上変数初期化
		ELSE
			;最初に訪れた時
			SETBIT ダンジョン構造配列_沿岸部の森:3:0, 2
			WSTR:(K++) = 「ダンジョンを歩いていると、たまにハプニングに遭遇することがある」
			WSTR:(K++) = 「もちろん君が大好きなえっちなハプニングのことさ」
			KSTR:(K++) = 「ほら、始まるぞ」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era")
			CALL ダンジョンハプニング_乳タッチ()

			CALL 口上変数初期化
			WSTR:(K++) = 「こういったハプニングは幾つか種類がある」
			WSTR:(K++) = 「一度しか見られないもの、ダンジョンを出たら復活するものなどだ」
			KSTR:(K++) = 「今回はダンジョンから出れば復活する。覚えていればまた次回楽しみたまえ」
			CALL メッセージ欄表示用関数("era_顔","星晶獣era")
			CALL 口上変数初期化
			SETBIT ダンジョン構造配列_沿岸部の森:7:0, 1
		ENDIF
		CALL 画面再描画
ENDSELECT

; @ダンジョンイベント位置_沿岸部の森_0_4
; SIF ダンジョン変数_沿岸部の森:0:4
; 	RETURN 0
; ダンジョンイベント:4:アイコン種類 = イベントアイコンリソース名数字変換("会話アイコン")
; ダンジョンイベント:4:X軸位置 = 16
; ダンジョンイベント:4:Y軸位置 = 17

; @ダンジョンイベント_沿岸部の森_0_4
; CALL 口上変数初期化
; WSTR:(K++) = 「これはイベントアイコン。触れれば何かしらの出来事が起こる」
; WSTR:(K++) = 「中身は千差万別だが、白いイベントアイコンでは戦闘は起こらない」
; KSTR:(K++) = 「対して、赤いイベントアイコンでは戦闘が起こる。この点については気をつけておけ」_PAGE_
; WSTR:(K++) = 「──と、これらエネミー、宝箱、イベントの３つが基本的なダンジョンイベントだ」
; KSTR:(K++) = 「十分に気をつけて進みたまえ、我が契約者」
; CALL メッセージ欄表示用関数("era_顔","星晶獣era")

; CALL 口上変数初期化
; CALL メッセージ欄表示用関数(,,,0)

; ダンジョン変数_沿岸部の森:0:4 = 1
; ダンジョンイベント:4:アイコン種類 = 0

