@アビテンプレート_ダメージ処理_自属性(効果オプション = "")
#DIMS 効果オプション
#DIM 対象番号
#DIM ダメージ量計算値

CALL アビテンプレート_効果共通処理
SIF RESULT == -1
	RETURN -1

FOR 対象番号, 0, 10
	SIF アビテンプレート用_対象保存:対象番号 < 0
		CONTINUE
	IF アビテンプレート用_対象保存:対象番号 < 10
		;味方対象
		IF STRCOUNT(効果オプション, "かばう無視") == 0
			IF アビテンプレート用_全体フラグ
				CALL かばうチェック_味方("全体かばう")
			ELSE
				CALL かばうチェック_味方("")
			ENDIF
			IF RESULT > -1
				アビテンプレート用_対象保存:対象番号 = RESULT
				アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %CALLNAME:(BATTLE_STATE:(アビテンプレート用_対象保存:対象番号):キャラ番号)%が攻撃をかばった！
			ENDIF
		ENDIF
		戦闘行動対象 = アビテンプレート用_対象保存:対象番号
		CALL ダメージ計算処理(アビ汎用変数:効果割合)
		ダメージ量計算値 = RESULT + アビ汎用変数:効果量
		アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %CALLNAME:(BATTLE_STATE:戦闘行動対象:キャラ番号)%に{ダメージ量計算値}のダメージ！
		BATTLE_STATE:戦闘行動対象:ＨＰ = MAX(BATTLE_STATE:戦闘行動対象:ＨＰ - ダメージ量計算値, 0)
		IF BATTLE_STATE:戦闘行動対象:ＨＰ < 1
			CALL 戦闘不能時処理(戦闘行動対象)
			アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %CALLNAME:(BATTLE_STATE:戦闘行動対象:キャラ番号)%は倒れた！
		ENDIF
	ELSE
		;敵対象
		IF STRCOUNT(効果オプション, "かばう無視") == 0
			IF アビテンプレート用_全体フラグ
				CALL かばうチェック_敵("全体かばう")
			ELSE
				CALL かばうチェック_敵("")
			ENDIF
			IF RESULT > -1
				アビテンプレート用_対象保存:対象番号 = RESULT
				アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %敵BATTLE_STATE_STR:(アビテンプレート用_対象保存:対象番号 - 10):エネミー名%が攻撃をかばった！
			ENDIF
		ENDIF
		戦闘行動対象 = アビテンプレート用_対象保存:対象番号
		CALL ダメージ計算処理(アビ汎用変数:効果割合)
		ダメージ量計算値 = RESULT + アビ汎用変数:効果量
		アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %敵BATTLE_STATE_STR:(戦闘行動対象 - 10):エネミー名%に{ダメージ量計算値}のダメージ！
		敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ = MAX(敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ - ダメージ量計算値, 0)
		IF 敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ < 1
			CALL 戦闘不能時処理(戦闘行動対象)
			アビテンプレート用_表示メッセージ格納:対象番号:(A_M_NUM:対象番号++) = %敵BATTLE_STATE_STR:(戦闘行動対象 - 10):エネミー名%は倒れた！
		ENDIF
	ENDIF
NEXT

@アビテンプレート_ダメージ処理_属性付き(属性番号, 効果オプション = "")
#DIMS 効果オプション
#DIM 属性一時保存
#DIM 属性番号

IF 戦闘行動キャラ < 10
	属性一時保存 = BATTLE_STATE:戦闘行動キャラ:属性
	BATTLE_STATE:戦闘行動キャラ:属性 = 属性番号
	CALL アビテンプレート_ダメージ処理_自属性(効果オプション)
	BATTLE_STATE:戦闘行動キャラ:属性 = 属性一時保存
ELSE
	属性一時保存 = 敵BATTLE_STATE:(戦闘行動キャラ - 10):属性
	敵BATTLE_STATE:(戦闘行動キャラ - 10):属性 = 属性番号
	CALL アビテンプレート_ダメージ処理_自属性(効果オプション)
	敵BATTLE_STATE:(戦闘行動キャラ - 10):属性 = 属性一時保存
ENDIF

@アビテンプレート_ダメージ処理_火属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(0, 効果オプション)

@アビテンプレート_ダメージ処理_水属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(1, 効果オプション)

@アビテンプレート_ダメージ処理_風属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(2, 効果オプション)

@アビテンプレート_ダメージ処理_土属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(3, 効果オプション)

@アビテンプレート_ダメージ処理_光属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(4, 効果オプション)

@アビテンプレート_ダメージ処理_闇属性(効果オプション = "")
#DIMS 効果オプション
CALL アビテンプレート_ダメージ処理_属性付き(5, 効果オプション)