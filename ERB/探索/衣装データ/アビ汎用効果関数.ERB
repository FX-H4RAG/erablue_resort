@アビ汎用変数文字列リセット
VARSET アビ汎用変数:0
VARSET アビ汎用文字列:0

@効果使用先設定_味方単体
CALL 口上変数初期化
KSTR:(K++) = 誰に使用しますか？
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = <button value='999'>[999]戻る</button>
キャラ画像ボタン化フラグ = 1
CALL メッセージ欄表示用関数(,,,0)
CALL 口上変数初期化
$INPUT_LOOP
INPUT
SELECTCASE RESULT
	CASE 0 TO 3
		IF BATTLE_STATE:RESULT:キャラ番号 < 1
			REUSELASTLINE 
			GOTO INPUT_LOOP
		ENDIF
		戦闘行動対象 = RESULT
	CASE 999
		RETURN -1
	CASEELSE
		REUSELASTLINE 
		GOTO INPUT_LOOP
ENDSELECT

@効果使用先設定_敵(処理オプション)
#DIMS 処理オプション
アビ汎用変数:かばうフラグ = 0

CALL 口上変数初期化
KSTR:(K++) = 誰に使用しますか？
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = 　
KSTR:(K++) = <button value='999'>[999]戻る</button>
エネミー画像ボタン化フラグ = 1
CALL メッセージ欄表示用関数(,,,0)
CALL 口上変数初期化
$INPUT_LOOP
INPUT
SELECTCASE RESULT
	CASE 10 TO 19
		IF 敵BATTLE_STATE_STR:(RESULT - 10):エネミー名 == ""
			REUSELASTLINE 
			GOTO INPUT_LOOP
		ELSEIF 敵BATTLE_STATE:(RESULT - 10):ＨＰ < 1
			REUSELASTLINE 
			GOTO INPUT_LOOP
		ENDIF
		戦闘行動対象 = RESULT
	CASE 999
		RETURN -1
	CASEELSE
		REUSELASTLINE 
		GOTO INPUT_LOOP
ENDSELECT

;かばうチェック
IF STRCOUNT(処理オプション, "全体かばう無視")
ELSE
	IF STRCOUNT(処理オプション, "単体かばう無視")
		CALL かばうチェック_敵("全体かばう")
	ELSE
		CALL かばうチェック_敵()
	ENDIF
ENDIF
@アビ汎用_通常ダメージ処理
;------------------------------------------------------------------------
;・使用変数
;アビ汎用変数:効果対象
;アビ汎用変数:攻撃倍率
;アビ汎用変数:防御無視率
;アビ汎用文字列:攻撃側使用能力値
;アビ汎用文字列:防御側使用能力値
;アビ汎用文字列:攻撃範囲
;アビ汎用変数:死亡フラグ
;------------------------------------------------------------------------
;返り値0:対象が不正 それ以外:与えたダメージ量
;------------------------------------------------------------------------
#DIM 実ダメージ量

LOCAL = アビ汎用変数:効果対象
IF LOCAL < 10 && BATTLE_STATE:LOCAL:キャラ番号 < 1
	PRINTW 対象が不正です。
	RETURN 0
ELSEIF LOCAL >= 10 && 敵BATTLE_STATE_STR:(LOCAL - 10):エネミー名 == ""
	PRINTW 対象が不正です。
	RETURN 0
ENDIF

IF アビ汎用文字列:攻撃側使用能力値 == ""
	アビ汎用文字列:攻撃側使用能力値 = 攻撃力
ENDIF
IF アビ汎用文字列:防御側使用能力値 == ""
	アビ汎用文字列:防御側使用能力値 = 防御力
ENDIF


CALL ダメージ計算処理(アビ汎用変数:攻撃倍率, アビ汎用変数:防御無視率, アビ汎用文字列:攻撃側使用能力値, アビ汎用文字列:防御側使用能力値)

実ダメージ量 = RESULT
IF LOCAL < 10
	BATTLE_STATE:戦闘行動対象:ＨＰ = MAX(BATTLE_STATE:戦闘行動対象:ＨＰ - 実ダメージ量, 0)
	IF BATTLE_STATE:戦闘行動対象:ＨＰ < 1
		CALL 戦闘不能時処理(戦闘行動対象)
		アビ汎用変数:死亡フラグ = 1
	ENDIF
ELSEIF LOCAL >= 10
	敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ = MAX(敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ - 実ダメージ量, 0)
	IF 敵BATTLE_STATE:(戦闘行動対象 - 10):ＨＰ < 1
		CALL 戦闘不能時処理(戦闘行動対象)
		アビ汎用変数:死亡フラグ = 1
	ENDIF
ENDIF

RETURN 実ダメージ量

@アビ汎用_ポンバ
;------------------------------------------------------------------------
;・使用変数
;アビ汎用変数:効果対象
;------------------------------------------------------------------------
;返り値0:対象が不正 -1:ゲージ100%以上 1:成功
;------------------------------------------------------------------------
LOCAL = アビ汎用変数:効果対象
IF LOCAL < 10
	IF BATTLE_STATE:LOCAL:キャラ番号 < 1
		PRINTW 対象が不正です。
		RETURN 0
	ENDIF
	IF BATTLE_STATE:LOCAL:奥義ゲージ < 100
		BATTLE_STATE:LOCAL:奥義ゲージ = 100
		RETURN 1
	ELSE
		RETURN -1
	ENDIF
ELSEIF LOCAL >= 10
	IF 敵BATTLE_STATE_STR:(LOCAL - 10):エネミー名 == ""
		PRINTW 対象が不正です。
		RETURN 0
	ENDIF
	敵BATTLE_STATE:(LOCAL - 10):チャージターン = 敵BATTLE_STATE:(LOCAL - 10):最大チャージターン
	RETURN 1
ENDIF


@アビ汎用_バフセット(アビ名)
;------------------------------------------------------------------------
;・使用変数
;アビ汎用変数:効果対象
;アビ汎用文字列:バフ・デバフ枠
;アビ汎用文字列:バフ・デバフ対象能力
;アビ汎用変数:効果割合
;アビ汎用変数:効果量
;アビ汎用変数:持続ターン
;アビ汎用変数:持続回数
;------------------------------------------------------------------------
;◯強化、◯耐性、連続攻撃率については初期値が０のため効果割合を入れても効果がないことに注意
;------------------------------------------------------------------------
;返り値0:対象が不正 -1:同じ枠で効果高いバフがすでにある 1:成功
;------------------------------------------------------------------------
#DIMS アビ名
#DIM ループ用
#DIM データベース行数
VARSET LOCAL

LOCAL = アビ汎用変数:効果対象
IF LOCAL < 10 && BATTLE_STATE:LOCAL:キャラ番号 < 1
	PRINTW 対象が不正です。
	RETURN 0
ELSEIF LOCAL >= 10 && 敵BATTLE_STATE_STR:(LOCAL - 10):エネミー名 == ""
	PRINTW 対象が不正です。
	RETURN 0
ENDIF

;既存のバフと枠が被ってないかチェック
データベース行数 = DT_ROW_LENGTH(@"バフデータベース_{LOCAL}")
FOR ループ用, 0, データベース行数
	IF DT_CELL_GETS(@"バフデータベース_{LOCAL}", ループ用, "バフ枠") == アビ汎用文字列:バフ・デバフ枠
		;すでに同じ枠のバフがある場合
		IF DT_CELL_GET(@"バフデータベース_{LOCAL}", ループ用, "バフ効果量_割合") == 0 && アビ汎用変数:効果割合 == 0
			;大本バフも追加バフも割合が０の時、固定値を比較
			IF DT_CELL_GET(@"バフデータベース_{LOCAL}", ループ用, "バフ効果量_固定値") <= アビ汎用変数:効果量
				;追加する方の割合が高いか同じ場合は消して新しく追加
				DT_ROW_REMOVE @"バフデータベース_{LOCAL}", ループ用
			ELSE
				;そうでない場合は終了
				RETURN -1
			ENDIF
		ELSEIF DT_CELL_GET(@"バフデータベース_{LOCAL}", ループ用, "バフ効果量_割合") <= アビ汎用変数:効果割合
			;追加する方の割合が高いか同じ場合は消して新しく追加
			DT_ROW_REMOVE @"バフデータベース_{LOCAL}", ループ用
		ELSE
			;そうでない場合は終了
			RETURN -1
		ENDIF
		BREAK
	ENDIF
NEXT

DT_ROW_ADD @"バフデータベース_{LOCAL}", "バフ枠", アビ汎用文字列:バフ・デバフ枠, "バフ対象能力", アビ汎用文字列:バフ・デバフ対象能力, "バフ効果量_割合", アビ汎用変数:効果割合, "バフ効果量_固定値", アビ汎用変数:効果量, "バフ名", アビ名, "持続ターン", アビ汎用変数:持続ターン, "持続回数", アビ汎用変数:持続回数, "持続行動回数", アビ汎用変数:持続行動回数

RETURN 1

@アビ汎用_デバフセット(アビ名)
;------------------------------------------------------------------------
;・使用変数
;アビ汎用変数:効果対象
;アビ汎用文字列:バフ・デバフ枠
;アビ汎用文字列:バフ・デバフ対象能力
;アビ汎用変数:効果割合
;アビ汎用変数:効果量
;アビ汎用変数:持続ターン
;アビ汎用変数:持続回数
;------------------------------------------------------------------------
;◯強化、◯耐性、連続攻撃率については初期値が０のため効果割合を入れても効果がないことに注意
;------------------------------------------------------------------------
;返り値0:対象が不正 -1:同じ枠で効果高いデバフがすでにある 1:成功
;------------------------------------------------------------------------
#DIMS アビ名
#DIM ループ用
#DIM データベース行数
VARSET LOCAL

LOCAL = アビ汎用変数:効果対象
IF LOCAL < 10 && BATTLE_STATE:LOCAL:キャラ番号 < 1
	PRINTW 対象が不正です。
	RETURN 0
ELSEIF LOCAL >= 10 && 敵BATTLE_STATE_STR:(LOCAL - 10):エネミー名 == ""
	PRINTW 対象が不正です。
	RETURN 0
ENDIF

;既存のバフと枠が被ってないかチェック
データベース行数 = DT_ROW_LENGTH(@"デバフデータベース_{LOCAL}")
FOR ループ用, 0, データベース行数
	IF DT_CELL_GETS(@"デバフデータベース_{LOCAL}", ループ用, "デバフ枠") == アビ汎用文字列:バフ・デバフ枠
		;すでに同じ枠のバフがある場合
		IF DT_CELL_GET(@"デバフデータベース_{LOCAL}", ループ用, "デバフ効果量_割合") <= アビ汎用変数:効果割合
			;追加する方の割合が高いか同じ場合は消して新しく追加
			DT_ROW_REMOVE @"デバフデータベース_{LOCAL}", ループ用
		ELSE
			;そうでない場合は終了
			RETURN -1
		ENDIF
		;固定値の量は上書きには考慮しない
		BREAK
	ENDIF
NEXT

DT_ROW_ADD @"デバフデータベース_{LOCAL}", "デバフ枠", アビ汎用文字列:バフ・デバフ枠, "デバフ対象能力", アビ汎用文字列:バフ・デバフ対象能力, "デバフ効果量_割合", アビ汎用変数:効果割合, "デバフ効果量_固定値", アビ汎用変数:効果量, "デバフ名", アビ名, "持続ターン", アビ汎用変数:持続ターン, "持続回数", アビ汎用変数:持続回数

RETURN 1
